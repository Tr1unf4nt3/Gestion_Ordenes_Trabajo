<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Órdenes de Trabajo | Firebase Cloud Edition (Seguro)</title>
    <!-- Librería para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRERÍAS DE FIREBASE (Versión de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* [MANTENER TODOS LOS ESTILOS EXISTENTES...] */

        /* NUEVOS ESTILOS PARA CERTIFICACIÓN */
        .certification-pdf-container {
            display: none;
            position: absolute;
            left: -9999px;
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 20mm;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
            line-height: 1.4;
        }
    </style>
</head>
<body>

    <!-- [MANTENER TODO EL HTML EXISTENTE...] -->

    <!-- CONTENEDOR OCULTO PARA PDF DE CERTIFICACIÓN -->
    <div id="certification-pdf-template" class="certification-pdf-container">
        <!-- El contenido se genera dinámicamente -->
    </div>

    <script>
        // [MANTENER TODAS LAS CONFIGURACIONES Y FUNCIONES EXISTENTES...]

        // FUNCIÓN COMPLETAMENTE REESCRITA: Generar PDF de certificación
        function generateCertificationPDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    console.log('Iniciando generación de PDF de certificación con datos:', data);
                    
                    const fileName = `Certificacion_Obra_${data.orderNumber}_${getCurrentCaracasDate().replace(/\//g, '-')}.pdf`;
                    
                    // Obtener el contenedor del template
                    const pdfContainer = document.getElementById('certification-pdf-template');
                    
                    // Limpiar contenido previo
                    pdfContainer.innerHTML = '';
                    
                    // Crear el contenido HTML directamente
                    const certificationHTML = `
                        <div style="font-family: Arial, sans-serif; color: #333; line-height: 1.4; width: 100%;">
                            <!-- Encabezado -->
                            <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #4682B4; padding-bottom: 15px;">
                                <h1 style="color: #4682B4; margin: 0; font-size: 24px; font-weight: bold;">
                                    CERTIFICACIÓN DE OBRA
                                </h1>
                                <div style="margin-top: 10px;">
                                    <div style="font-weight: bold; color: #555; font-size: 14px;">
                                        Número de Certificación: <span style="color: #333;">${data.certification_number || 'N/A'}</span>
                                    </div>
                                    <div style="font-weight: bold; color: #555; font-size: 14px;">
                                        Fecha de Emisión: <span style="color: #333;">${data.certification_date || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección I: Datos de Certificación -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #4682B4; margin: 0 0 10px 0; padding: 8px 0; border-bottom: 1px solid #B0C4DE; font-size: 16px;">
                                    I. Datos de Certificación
                                </h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE; width: 40%;">
                                            Número de Certificación:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE; width: 60%;">
                                            ${data.certification_number || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Fecha:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.certification_date || 'N/A'}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Sección II: Identificación -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #4682B4; margin: 0 0 10px 0; padding: 8px 0; border-bottom: 1px solid #B0C4DE; font-size: 16px;">
                                    II. Identificación
                                </h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE; width: 40%;">
                                            Empresa:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE; width: 60%;">
                                            ${data.certification_empresa || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Apellido y Nombre del Responsable:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.certification_responsable || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Rif:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.certification_rif || 'N/A'}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Sección III: Información del Proyecto -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #4682B4; margin: 0 0 10px 0; padding: 8px 0; border-bottom: 1px solid #B0C4DE; font-size: 16px;">
                                    III. Información del Proyecto
                                </h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE; width: 40%;">
                                            Referencia Orden de Trabajo:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE; width: 60%;">
                                            ${data.certification_reference || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Fecha de Inicio:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.start_date ? formatDateToDDMMYYYY(data.start_date) : 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Fecha de finalización:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.end_date ? formatDateToDDMMYYYY(data.end_date) : 'N/A'}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Sección IV: Detalle de los trabajos -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #4682B4; margin: 0 0 10px 0; padding: 8px 0; border-bottom: 1px solid #B0C4DE; font-size: 16px;">
                                    IV. Detalle de los trabajos
                                </h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE; width: 40%; vertical-align: top;">
                                            Conceptos Ejecutados en el período de tiempo:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE; width: 60%; min-height: 80px; word-wrap: break-word; white-space: pre-wrap;">
                                            ${data.conceptos_ejecutados || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Total Acreditado en Certificación:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.total_acreditado || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Porcentaje sobre el presupuesto total:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.porcentaje_presupuesto || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Importe final acreditado en la construcción:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.importe_final || 'N/A'}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Sección V: Desviaciones y Justificación -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #4682B4; margin: 0 0 10px 0; padding: 8px 0; border-bottom: 1px solid #B0C4DE; font-size: 16px;">
                                    V. Desviaciones y Justificación
                                </h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE; width: 40%; vertical-align: top;">
                                            Desviaciones y Justificación:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE; width: 60%; min-height: 120px; word-wrap: break-word; white-space: pre-wrap;">
                                            ${data.desviaciones_justificacion || 'N/A'}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Firmas -->
                            <div style="margin-top: 60px; padding-top: 30px; border-top: 2px dashed #B0C4DE;">
                                <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: bold;">
                                    <div style="width: 45%; text-align: center;">
                                        Firma Gerente Técnico:
                                        <div style="border-top: 1px solid #333; margin-top: 80px; width: 80%; margin-left: auto; margin-right: auto;"></div>
                                    </div>
                                    <div style="width: 45%; text-align: center;">
                                        Firma Jefe Técnico:
                                        <div style="border-top: 1px solid #333; margin-top: 80px; width: 80%; margin-left: auto; margin-right: auto;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Asignar el contenido al contenedor
                    pdfContainer.innerHTML = certificationHTML;
                    
                    // Hacer visible temporalmente el contenedor
                    pdfContainer.style.display = 'block';
                    pdfContainer.style.position = 'relative';
                    pdfContainer.style.left = '0';
                    pdfContainer.style.top = '0';

                    console.log('Contenido HTML generado para PDF de certificación');

                    const opt = {
                        margin:       10,
                        filename:     fileName,
                        image:        { 
                            type: 'jpeg', 
                            quality: 0.98 
                        },
                        html2canvas:  { 
                            scale: 2,
                            useCORS: true,
                            logging: true,
                            scrollX: 0,
                            scrollY: 0,
                            width: 210, // Ancho en mm
                            height: 297, // Alto en mm
                            windowWidth: 794, // Ancho en píxeles para A4
                            windowHeight: 1123 // Alto en píxeles para A4
                        },
                        jsPDF:        { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true
                        }
                    };

                    // Esperar un poco para que el DOM se actualice
                    setTimeout(() => {
                        console.log('Iniciando generación de PDF con html2pdf...');
                        
                        html2pdf()
                            .set(opt)
                            .from(pdfContainer)
                            .save()
                            .then(() => {
                                console.log('✅ PDF de certificación generado exitosamente:', fileName);
                                
                                // Restaurar el estado del contenedor
                                pdfContainer.style.display = 'none';
                                pdfContainer.style.position = 'absolute';
                                pdfContainer.style.left = '-9999px';
                                pdfContainer.style.top = '0';
                                
                                resolve();
                            })
                            .catch(error => {
                                console.error('❌ Error al generar PDF de certificación:', error);
                                
                                // Restaurar el estado del contenedor incluso en error
                                pdfContainer.style.display = 'none';
                                pdfContainer.style.position = 'absolute';
                                pdfContainer.style.left = '-9999px';
                                pdfContainer.style.top = '0';
                                
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generateCertificationPDF:', error);
                    reject(error);
                }
            });
        }

        // FUNCIÓN ALTERNATIVA: Si la anterior no funciona, usar esta
        function generateCertificationPDFAlternative(data) {
            return new Promise((resolve, reject) => {
                try {
                    console.log('Usando método alternativo para generar PDF...');
                    
                    const fileName = `Certificacion_Obra_${data.orderNumber}_${getCurrentCaracasDate().replace(/\//g, '-')}.pdf`;
                    
                    // Crear un elemento temporal visible
                    const tempDiv = document.createElement('div');
                    tempDiv.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 210mm;
                        min-height: 297mm;
                        background: white;
                        padding: 20mm;
                        font-family: Arial, sans-serif;
                        box-sizing: border-box;
                        line-height: 1.4;
                        z-index: 10000;
                        border: 1px solid #ccc;
                    `;

                    // Mismo contenido HTML que la función anterior
                    tempDiv.innerHTML = `
                        <div style="font-family: Arial, sans-serif; color: #333; line-height: 1.4; width: 100%;">
                            <!-- Mismo contenido HTML que la función generateCertificationPDF -->
                            <!-- Copiar exactamente el mismo HTML de la función anterior -->
                            <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #4682B4; padding-bottom: 15px;">
                                <h1 style="color: #4682B4; margin: 0; font-size: 24px; font-weight: bold;">
                                    CERTIFICACIÓN DE OBRA
                                </h1>
                                <div style="margin-top: 10px;">
                                    <div style="font-weight: bold; color: #555; font-size: 14px;">
                                        Número de Certificación: <span style="color: #333;">${data.certification_number || 'N/A'}</span>
                                    </div>
                                    <div style="font-weight: bold; color: #555; font-size: 14px;">
                                        Fecha de Emisión: <span style="color: #333;">${data.certification_date || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Aquí continuar con todas las secciones igual que en la función anterior -->
                            <!-- Sección I -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #4682B4; margin: 0 0 10px 0; padding: 8px 0; border-bottom: 1px solid #B0C4DE; font-size: 16px;">
                                    I. Datos de Certificación
                                </h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE; width: 40%;">
                                            Número de Certificación:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE; width: 60%;">
                                            ${data.certification_number || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Fecha:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.certification_date || 'N/A'}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Sección II -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #4682B4; margin: 0 0 10px 0; padding: 8px 0; border-bottom: 1px solid #B0C4DE; font-size: 16px;">
                                    II. Identificación
                                </h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE; width: 40%;">
                                            Empresa:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE; width: 60%;">
                                            ${data.certification_empresa || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Apellido y Nombre del Responsable:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.certification_responsable || 'N/A'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">
                                            Rif:
                                        </td>
                                        <td style="padding: 10px; border: 1px solid #B0C4DE;">
                                            ${data.certification_rif || 'N/A'}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Continuar con las demás secciones... -->
                            <!-- ... (copiar el resto de las secciones de la función anterior) ... -->

                        </div>
                    `;

                    document.body.appendChild(tempDiv);

                    const opt = {
                        margin: 10,
                        filename: fileName,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { 
                            scale: 2,
                            useCORS: true,
                            logging: true
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait'
                        }
                    };

                    setTimeout(() => {
                        html2pdf()
                            .set(opt)
                            .from(tempDiv)
                            .save()
                            .then(() => {
                                document.body.removeChild(tempDiv);
                                resolve();
                            })
                            .catch(error => {
                                document.body.removeChild(tempDiv);
                                reject(error);
                            });
                    }, 2000);

                } catch (error) {
                    console.error('Error en método alternativo:', error);
                    reject(error);
                }
            });
        }

        // MODIFICAR la función generateCertification para usar el método que funcione
        async function generateCertification() {
            const form = document.getElementById('certification-work-form');
            const formData = new FormData(form);
            
            // [MANTENER LA VALIDACIÓN EXISTENTE...]

            // Recopilar datos del formulario
            const certificationData = {
                orderId: currentOrderForCertification.id,
                orderNumber: currentOrderForCertification['Orden de Trabajo'],
                fecha_creacion: new Date().toISOString(),
                certificacion_completa: true
            };

            CERTIFICATION_FORM_STRUCTURE.forEach(section => {
                section.fields.forEach(field => {
                    if (field.type === 'static' || field.type === 'date-auto') {
                        const inputElement = document.getElementById(field.id);
                        certificationData[field.id] = inputElement ? inputElement.value : '';
                    } else {
                        certificationData[field.id] = formData.get(field.id) || '';
                    }
                });
            });

            try {
                // Guardar certificación en Firebase
                await CERTIFICATIONS_COLLECTION.add(certificationData);
                
                // Actualizar estado de la orden
                await ORDERS_COLLECTION.doc(currentOrderForCertification.id).update({
                    estado: "Finalizada",
                    fecha_finalizacion: new Date().toISOString()
                });

                // Actualizar datos locales
                const orderIndex = workOrders.findIndex(o => o.id === currentOrderForCertification.id);
                if (orderIndex !== -1) {
                    workOrders[orderIndex].estado = "Finalizada";
                    workOrders[orderIndex].fecha_finalizacion = new Date().toISOString();
                }

                // Intentar generar PDF - probar ambos métodos
                console.log('Intentando generar PDF de certificación...');
                
                try {
                    await generateCertificationPDF(certificationData);
                    console.log('✅ PDF generado con método principal');
                } catch (error1) {
                    console.warn('Método principal falló, intentando método alternativo...', error1);
                    try {
                        await generateCertificationPDFAlternative(certificationData);
                        console.log('✅ PDF generado con método alternativo');
                    } catch (error2) {
                        console.error('Ambos métodos fallaron:', error2);
                        throw new Error('No se pudo generar el PDF: ' + error2.message);
                    }
                }

                alert('✅ Certificación generada exitosamente y orden marcada como finalizada.');
                goBackToOrders();
                
            } catch (error) {
                console.error('Error al generar certificación:', error);
                alert('Error al generar la certificación: ' + error.message);
            }
        }

    </script>
</body>
</html>
