<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition (Seguro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;         /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;    /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE;  /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;     /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;       /* Gris carb√≥n (Charcoal) */
            --color-white: #ffffff;
            --color-error: #FF6961;      /* Rojo pastel para errores */
            --color-success: #77DD77;    /* Verde pastel para √©xito */
        }

        /* Estilos Generales (Dise√±o Pastel) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2, h3, h4 {
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 25px;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="email"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-white);
        }

        /* Estilo para campos autollenados/deshabilitados */
        input:disabled {
            background-color: #f0f0f0; 
            border: 1px dashed var(--color-secondary);
        }

        /* Estilo de validaci√≥n (el navegador se encarga de lo b√°sico, pero esto ayuda) */
        input:invalid:not(:placeholder-shown), select:invalid:not(:placeholder-shown), textarea:invalid:not(:placeholder-shown) {
            border: 2px solid var(--color-error);
        }

        .form-section {
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #f7fbff;
        }

        /* Contenedor Flex para Campos de C√°lculo */
        .calculation-group {
            display: flex;
            align-items: center;
            gap: 10px;
            /* Flex vertical para etiquetas y horizontal para inputs/resultados */
            flex-wrap: wrap; 
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            background-color: #e0f7fa; /* Fondo azul claro para destacar el c√°lculo */
        }

        /* Estilo para la etiqueta y el input del Total calculado */
        .calculation-total-section {
            display: flex;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }

        .calculation-total-section label {
            font-weight: bold;
            flex-basis: auto; 
            margin-right: 15px;
            white-space: nowrap;
        }

        .total-display {
            background-color: var(--color-white);
            font-weight: bold;
            text-align: right;
            border: 1px dashed var(--color-accent);
            padding: 10px;
            border-radius: 6px;
            flex-grow: 1;
        }

        .calculation-input { 
            flex-basis: calc(45% - 20px); 
        } 
        .calculation-group .formula-symbol {
            font-size: 1.5em; 
            font-weight: bold; 
            margin-left: 5px; 
            margin-right: 5px;
        }

        button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 10px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform: 0.1s;
        }

        button:hover {
            background-color: var(--color-primary);
        }
        
        /* Botones de Check Condicional */
        .conditional-check {
            background-color: var(--color-secondary);
            color: var(--color-white);
            font-weight: bold;
            padding: 15px;
            margin-bottom: 10px;
            display: block;
            text-align: left;
        }
        .conditional-check.active {
            background-color: var(--color-success);
        }


        /* Layout de Pesta√±as */
        .tab { overflow: hidden; border-bottom: 1px solid var(--color-secondary); margin-bottom: 20px; }
        .tablinks { background-color: var(--color-bg); color: var(--color-text); float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: 0.3s; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .tablinks:hover { background-color: var(--color-primary); }
        .tablinks.active { background-color: var(--color-primary); border-bottom: 3px solid var(--color-accent); margin-bottom: -1px; }
        .tabcontent { display: none; padding: 30px 0; }

        /* Estilos de Edici√≥n */
        .field-editor-item { border: 1px dashed var(--color-secondary); border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: var(--color-white); }
        .required-fixed-field { padding: 10px; background-color: var(--color-secondary); color: var(--color-white); border-radius: 4px; margin-bottom: 10px; }
        
        /* Estilos para la tabla */
        #orders-table { width: 100%; border-collapse: collapse; }
        #orders-table th, #orders-table td { border: 1px solid var(--color-secondary); padding: 12px; text-align: left; }
        #orders-table th { background-color: var(--color-primary); color: var(--color-text); }
        #orders-table tr:nth-child(even) { background-color: var(--color-bg); }
        #orders-table tr:hover { background-color: var(--color-accent); color: var(--color-white); }

        /* Login View */
        #login-view { width: 350px; padding: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--color-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-error { color: var(--color-error); font-weight: bold; }
        
        /* Estilo para las firmas en el PDF */
        .pdf-signatures {
            margin-top: 60px; /* 1cm m√°s abajo */
            padding-top: 30px;
            border-top: 1px dashed #B0C4DE;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
        }
        .pdf-signatures span {
            display: inline-block;
            width: 45%; /* Ajuste para espacio entre firmas */
        }
        .pdf-signatures hr {
            border: none;
            border-top: 1px solid #36454F;
            margin: 5px 0 0 0;
        }
        
        /* Estilos espec√≠ficos para el encabezado en p√°ginas > 1 del PDF */
        .pdf-header-secondary {
            position: fixed; /* Fijo en la parte superior */
            top: 10px; /* Posici√≥n ajustada para evitar margen */
            right: 20px; /* Posici√≥n ajustada para el lado derecho */
            font-size: 14px; /* Tama√±o similar al de las secciones */
            color: #555;
            font-weight: bold;
            z-index: 1000;
        }

    </style>
</head>
<body>

    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <div class="tab">
            <button class="tablinks" id="new-order-tab-button" onclick="openTab(event, 'new-order')">üìã Nueva Orden de Trabajo</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes Creadas</button>
            <button class="tablinks" id="edit-tab-button" onclick="openTab(event, 'edit-form')" style="display: none;">‚öôÔ∏è Edici√≥n de Formulario</button>
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <div id="view-orders" class="tabcontent">
            <h3>Registro Hist√≥rico de √ìrdenes</h3>
            <table id="orders-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Creaci√≥n</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="edit-form" class="tabcontent">
            <h3>Edici√≥n de Formulario</h3>
            <div id="form-editor"></div>
            <button onclick="saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>
            <button onclick="cleanDuplicateOrders()" style="background-color: var(--color-error); color: white; margin-left: 10px;">üßπ Limpiar Duplicados</button>
        </div>
    </div>

    <script>
        // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
        
        // ** CONFIGURACI√ìN DE FIREBASE ACTUALIZADA **
        const firebaseConfig = {
          apiKey: "AIzaSyC40g7AnTbn2mtamOx_siPhckajgNCjZmg",
          authDomain: "gestionordenestrabajo.firebaseapp.com",
          projectId: "gestionordenestrabajo",
          storageBucket: "gestionordenestrabajo.firebasestorage.app",
          messagingSenderId: "478774861151",
          appId: "1:478774861151:web:e956dca23988e5d8fceaea"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Referencias a las "colecciones" de la base de datos
        const ORDERS_COLLECTION = db.collection("workOrders");
        const CONFIG_COLLECTION = db.collection("config"); 
        
        // Variables de estado
        let formStructure = null; 
        let workOrders = []; 
        let otCounter = 1; 
        let currentRole = null; 

        // ----------------------------------------------------------------------------------
        // *** CONFIGURACI√ìN DE ROLES CON M√öLTIPLES CORREOS (LISTAS/ARRAYS) ***
        // ----------------------------------------------------------------------------------

        // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de administrador
        const ADMIN_EMAILS = [
            'labortradingsg@gmail.com', // El correo que usted configur√≥
            '' // Otro administrador de ejemplo
        ]; 

        // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de solo visualizaci√≥n
        const VIEWER_EMAILS = [
            'visualizador1@empresa.com',
            'visualizador2@empresa.com',
            'solo.ver@tudominio.com' // Visualizador de ejemplo
        ]; 

        // ----------------------------------------------------------------------------------
        // *** FIN CONFIGURACI√ìN DE ROLES ***
        // ----------------------------------------------------------------------------------
        
        // *** DATOS FIJOS PARA AUTOLENADO DE CONTRATISTAS ***
        const CONTRATISTAS_DATA = {
            "Seleccione una Empresa": {
                "Apellido y Nombre del Responsable": "",
                "Rif": ""
            },
            " JERM TELECOMTRONICS TECHNOLOGY MULTISERVICES  C.A": {
                "Apellido y Nombre del Responsable": "JOHN RIVAS",
                "Rif": "J-50507058-4"
            },
            "CHASSERAL  C.A": {
                "Apellido y Nombre del Responsable": "YORKFRAN PERAZA",
                "Rif": "J-29510646-7"
            },
            "CONSERVI AJ C.A": {
                "Apellido y Nombre del Responsable": "ALFONZO BASTARDO",
                "Rif": "J-29548400-3"
            },
            "CORPORACION ACEL  C.A": {
                "Apellido y Nombre del Responsable": "DANIEL GONCALVES",
                "Rif": "J-30860621-9"
            },
            "CORPORACI√ìN TORRA NET 2022  C.A": {
                "Apellido y Nombre del Responsable": "JESUS TORRADO",
                "Rif": "J-50308479-0"
            },
            "DISTRIBUIDORA TODO EN REDES G.S.R  C.A": {
                "Apellido y Nombre del Responsable": "GASTON BUIZA",
                "Rif": "J-40424835-8"
            },
            "FIBRA INTEGRA  C.A": {
                "Apellido y Nombre del Responsable": "MARIE ANTONIETTE DAHDAH",
                "Rif": "J-50265450-0"
            },
            "G&D INTEGRAL RED 2023": {
                "Apellido y Nombre del Responsable": "RAFAEL GOMEZ",
                "Rif": "J-50298686-3"
            },
            "GLOBAL FIX C.A": {
                "Apellido y Nombre del Responsable": "CECILIA CASTRO - JEAN PIERRE LAPARROUSAZ",
                "Rif": "J-31189038-6"
            },
            "INT.TV  C.A": {
                "Apellido y Nombre del Responsable": "RAFAEL BERNAEZ",
                "Rif": "J-50301107-6"
            },
            "INVERSIONES ELECTROMTEC 2020  C.A": {
                "Apellido y Nombre del Responsable": "IGOR REGALADO",
                "Rif": "J-50082533-1"
            },
            "INVERSIONES PROYECTOS LG 721  C.A": {
                "Apellido y Nombre del Responsable": "DOMENICO LOLLI",
                "Rif": "J-29831930-5"
            },
            "INVERSIONES TELE MATIK 321 C.A": {
                "Apellido y Nombre del Responsable": "EDICSON TORRES - KATIUSKA",
                "Rif": "J-29867936-0"
            },
            "JR TECH SUPPORT  C.A": {
                "Apellido y Nombre del Responsable": "YENSY MARTINEZ",
                "Rif": "J-50032575-4"
            },
            "LG ALPHA SOLUCIONES  C.A": {
                "Apellido y Nombre del Responsable": "GILBERTO BERNAEZ",
                "Rif": "J-50319061-2"
            },
            "MULTI INVERSIONES LA LOVERE√ëA C.A": {
                "Apellido y Nombre del Responsable": "CARLOS TOLEDO",
                "Rif": "J-40492572-4"
            },
            "MULTISERVICIOS DAYRA-TEC  C.A": {
                "Apellido y Nombre del Responsable": "MARINES GOMEZ",
                "Rif": "J-50331914-3"
            },
            "PHONE MARKET STAR C.A": {
                "Apellido y Nombre del Responsable": "NELSON MORA",
                "Rif": "J-30919375-9"
            },
            "PROMOCIONES Y MERCADEO J FRANCHI C.A": {
                "Apellido y Nombre del Responsable": "JOSE FRANCHI",
                "Rif": "J-31574714-6"
            },
            "ROM-AR SERVICIOS Y MANTENIMIENTO  C.A": {
                "Apellido y Nombre del Responsable": "ELENA RUIZ",
                "Rif": "J-31128189-4"
            },
            "SERVICIOS DE TECNOLOGIA E INNOVACION (SERVITECH)  C.A": {
                "Apellido y Nombre del Responsable": "JHOAN CELIS",
                "Rif": "J-50028078-5"
            },
            "SERVICIOS INTEGRALES RFCF  C.A": {
                "Apellido y Nombre del Responsable": "CESAR",
                "Rif": "J-40387720-3"
            },
            "SERVICIOS J&G SOLUTION  C.A": {
                "Apellido y Nombre del Responsable": "JESUS BERNAEZ",
                "Rif": "J-50201745-3"
            },
            "SERVICIOS R G C.A": {
                "Apellido y Nombre del Responsable": "NELSON PORRA",
                "Rif": "J-29624230-5"
            },
            "SERVICIOS TEALCA C.A": {
                "Apellido y Nombre del Responsable": "FRANKLYN MENDOZA",
                "Rif": "J-31521527-6"
            },
            "SERVINDRECO C.A": {
                "Apellido y Nombre del Responsable": "OSCAR GUERRERO",
                "Rif": "J-31347293-0"
            },
            "SUMINISTROS INDUSTRIALES JAMIG C.A": {
                "Apellido y Nombre del Responsable": "MIGUEL PEREZ",
                "Rif": "J-40990643-4"
            },
            "SYCO 73  C.A": {
                "Apellido y Nombre del Responsable": "JUAN SIVIRA",
                "Rif": "J-31762306-1"
            },
            "TELECOMUNICACIONES JD SISTEM  C.A": {
                "Apellido y Nombre del Responsable": "FLAVIA GOMEZ",
                "Rif": "J-50126527-5"
            },
            "TELEIBARRA CA&EC  C.A": {
                "Apellido y Nombre del Responsable": "CARLOS IBARRA",
                "Rif": "J-50481799-6"
            },
            "W&S TECNOMARKET C.A": {
                "Apellido y Nombre del Responsable": "YERWILL SILVA",
                "Rif": "J-30993225-0"
            },
            "WV SOLUCIONES TECNO-EMPRESARIALES  C.A": {
                "Apellido y Nombre del Responsable": "WILLIAN VALERO",
                "Rif": "J-40973178-2"
            }
        };

        // Estructura inicial por defecto 
        const DEFAULT_FORM_STRUCTURE = [
            { title: "I. Informaci√≥n General", fields: [
                { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                { id: "ot_number", label: "Orden de Trabajo", type: "ot_counter", required: true },
                // CAMPO NUEVO: Autocompletar con el usuario logueado (user-auto-fill)
                { id: "user_auto_fill", label: "Usuario que Crea la Orden", type: "user-auto-fill", required: true },
                { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true }
            ]},
            { title: "II. Informaci√≥n de la Contratista", fields: []},
            { title: "III. Informaci√≥n del Trabajo/Obra", fields: []}
        ];
        
        // *** 2. L√ìGICA DE FIREBASE: CARGA Y GUARDADO ***

        async function loadInitialData() {
            try {
                // Cargar Estructura del Formulario y Contador
                const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                if (configDoc.exists) {
                    const data = configDoc.data();
                    formStructure = data.formStructure || DEFAULT_FORM_STRUCTURE;
                    
                    // L√≥gica de Migraci√≥n: si faltan campos fijos (como el nuevo de usuario), los agregamos.
                    const infoGeneralFields = formStructure[0].fields;
                    const hasUserField = infoGeneralFields.some(f => f.id === 'user_auto_fill');
                    if (!hasUserField) {
                         // Insertar el campo de usuario en la posici√≥n correcta (antes de la fecha)
                         const dateIndex = infoGeneralFields.findIndex(f => f.id === 'current_date');
                         if (dateIndex !== -1) {
                             infoGeneralFields.splice(dateIndex, 0, DEFAULT_FORM_STRUCTURE[0].fields[2]);
                         } else {
                             // Si no encuentra la fecha, lo pone al final de la secci√≥n I
                             infoGeneralFields.push(DEFAULT_FORM_STRUCTURE[0].fields[2]);
                         }
                    }

                    // L√≥gica de Migraci√≥n de t√≠tulos (siempre los mantenemos con el romano)
                    if (formStructure.length >= 3) {
                         if (formStructure[0].title === "Informaci√≥n General" || formStructure[0].title === "I. Informaci√≥n General") formStructure[0].title = "I. Informaci√≥n General";
                         if (formStructure[1].title === "Informaci√≥n de la Contratista" || formStructure[1].title === "II. Informaci√≥n de la Contratista") formStructure[1].title = "II. Informaci√≥n de la Contratista";
                         if (formStructure[2].title === "Informaci√≥n del Trabajo/Obra" || formStructure[2].title === "III. Informaci√≥n del Trabajo/Obra") formStructure[2].title = "III. Informaci√≥n del Trabajo/Obra";
                    }

                    otCounter = data.otCounter || 1;
                } else {
                    // Primera vez: usa el valor por defecto y gu√°rdalo
                    formStructure = DEFAULT_FORM_STRUCTURE;
                    await saveFormStructure(true); 
                }
                
                // Cargar √ìrdenes de Trabajo CON ORDENAMIENTO
                const ordersSnapshot = await ORDERS_COLLECTION.orderBy('Fecha Actual', 'desc').get();
                workOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Asegurar que el contador est√© correcto al inicio
                recalculateOtCounter();

            } catch (e) {
                console.error("Error cargando datos iniciales: ", e);
                alert("Error al conectar con la base de datos. Verifique su conexi√≥n y las reglas de seguridad de Firestore. Detalles: " + e.message);
            }
        }
        
        async function saveFormStructure(initial = false) {
            try {
                await CONFIG_COLLECTION.doc("systemConfig").set({
                    formStructure: formStructure,
                    otCounter: otCounter
                }, { merge: true });

                if (!initial) {
                     alert('üéâ Estructura del formulario y contador guardados exitosamente en la nube.');
                     renderWorkOrderForm();
                }
            } catch (e) {
                console.error("Error al guardar la estructura:", e);
                alert("Error al guardar la estructura en Firebase.");
            }
        }
        
        // MODIFICADA: L√≥gica de Roles
        function getRoleFromEmail(email) {
            if (ADMIN_EMAILS.includes(email)) {
                return 'admin';
            } 
            else if (VIEWER_EMAILS.includes(email)) { 
                return 'viewer'; 
            } 
            else {
                return 'normal'; 
            }
        }

        // SIN CAMBIOS MAYORES
        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            
            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                
                let role = getRoleFromEmail(user.email); 
                
                currentRole = role;
                
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initializeApp(role);
                
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error.code, error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorElement.textContent = 'Credenciales incorrectas o usuario no encontrado.';
                } else if (error.code === 'auth/invalid-email') {
                    errorElement.textContent = 'El formato del correo es inv√°lido.';
                } else if (error.code === 'auth/api-key-not-valid') {
                    errorElement.textContent = 'ERROR DE CONFIGURACI√ìN: La Clave API de Firebase no es v√°lida. Por favor, verifique la configuraci√≥n de Firebase en el c√≥digo.';
                } else {
                    errorElement.textContent = 'Error de conexi√≥n. Intente de nuevo.';
                }
            }
        }

        // SIN CAMBIOS
        function logout() {
            firebase.auth().signOut().then(() => {
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                alert('Sesi√≥n cerrada correctamente.');
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                alert('Error al cerrar sesi√≥n.');
            });
        }

        // MODIFICADA: Control de visibilidad de pesta√±as para los 3 roles
        async function initializeApp(role) {
            const isCreator = (role === 'admin' || role === 'normal');

            document.getElementById('edit-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
            document.getElementById('new-order-tab-button').style.display = isCreator ? 'inline-block' : 'none';
            
            await loadInitialData(); 
            
            if (role === 'admin') {
                renderFormEditor();
                openTab(null, 'edit-form');
            } else if (role === 'normal') {
                openTab(null, 'new-order');
            } else if (role === 'viewer') {
                openTab(null, 'view-orders'); 
            }
            
            renderWorkOrderForm();
            renderOrdersTable();
        }

        // MODIFICADA: Usa getRoleFromEmail() para los 3 roles
        window.onload = function() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    let role = getRoleFromEmail(user.email); 
                    currentRole = role;
                    
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    initializeApp(role);
                } else {
                    currentRole = null;
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('login-view').style.display = 'block';
                }
            });
        }
        
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) evt.currentTarget.className += " active";

            if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
            else if (tabName === 'view-orders') renderOrdersTable();
            else if (tabName === 'edit-form' && currentRole === 'admin' && formStructure) renderFormEditor();
        }
        
        // *** 4. L√ìGICA DE EDICI√ìN DE FORMULARIO (ADMIN) ***

        function renderFormEditor() {
            const editorDiv = document.getElementById('form-editor');
            editorDiv.innerHTML = '';

            formStructure.forEach((section, secIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `
                    <h4>Secci√≥n ${secIndex + 1}: <input type="text" value="${section.title}" oninput="updateSectionTitle(${secIndex}, this.value)" style="width: 70%; display: inline;"></h4>
                    <button onclick="addField(${secIndex}, 'text')">‚ûï Agregar Campo de Texto</button>
                    <button onclick="addField(${secIndex}, 'select')">‚ûï Agregar Lista (Select)</button>
                    <button onclick="addField(${secIndex}, 'date-input')">üìÖ Agregar Campo de Fecha</button>
                    <button onclick="addField(${secIndex}, 'textarea')">üìù Agregar √Årea de Texto</button>
                    <hr>
                    <div id="fields-container-${secIndex}"></div>
                `;
                editorDiv.appendChild(sectionDiv);

                const fieldsContainer = document.getElementById(`fields-container-${secIndex}`);
                section.fields.forEach((field, fieldIndex) => {
                    // user-auto-fill al listado de campos fijos
                    if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill') {
                        fieldsContainer.innerHTML += `<p class="required-fixed-field"><strong>${field.label}</strong> (Campo fijo obligatorio)</p>`;
                        return;
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-editor-item';
                    fieldDiv.innerHTML = `
                        <label>Etiqueta:</label>
                        <input type="text" value="${field.label}" oninput="updateFieldProperty(${secIndex}, ${fieldIndex}, 'label', this.value)">
                        <label>Tipo:</label>
                        <select onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texto (Corto)</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>√Årea de Texto (Largo)</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Lista Desplegable (Simple)</option>
                            <option value="autofill-select" ${field.type === 'autofill-select' ? 'selected' : ''}>Lista (Autollenado Contratista) üìù</option>
                            <option value="date-input" ${field.type === 'date-input' ? 'selected' : ''}>Fecha (Calendario) üìÖ</option>
                        </select>
                        <label>Clasificaci√≥n:</label>
                        <input type="checkbox" id="req-${secIndex}-${fieldIndex}" ${field.required ? 'checked' : ''} onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'required', this.checked)"> 
                        <label for="req-${secIndex}-${fieldIndex}" style="display: inline-block; font-weight: normal;">Obligatorio</label>
                        
                        <div id="select-options-${secIndex}-${fieldIndex}" style="margin-top: 10px; ${field.type !== 'select' && field.type !== 'autofill-select' ? 'display: none;' : ''}">
                            <strong>Opciones de Lista (solo visible si es 'Select' o 'Autofill-Select'). </strong>
                            ${field.type === 'autofill-select' ? 
                                '<p style="color: var(--color-error);">‚ö†Ô∏è **Autollenado:** Las opciones se toman de `CONTRATISTAS_DATA` y anulan esta lista.</p>' : ''
                            }
                            <input type="text" value="${(field.options || []).join(', ')}" oninput="updateSelectOptions(${secIndex}, ${fieldIndex}, this.value)">
                        </div>
                        <button onclick="removeField(${secIndex}, ${fieldIndex})" style="background-color: var(--color-error); color: var(--color-white);">üóëÔ∏è Eliminar Campo</button>
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });
            });
        }
        
        function updateSectionTitle(secIndex, newTitle) { formStructure[secIndex].title = newTitle; }

        function updateFieldProperty(secIndex, fieldIndex, prop, value) {
            formStructure[secIndex].fields[fieldIndex][prop] = value;
            if (prop === 'type') {
                if ((value === 'select' || value === 'autofill-select') && !formStructure[secIndex].fields[fieldIndex].options) {
                    formStructure[secIndex].fields[fieldIndex].options = ['Opci√≥n A', 'Opci√≥n B'];
                }
                renderFormEditor();
            }
        }

        function updateSelectOptions(secIndex, fieldIndex, value) {
            formStructure[secIndex].fields[fieldIndex].options = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
        }

        function addField(secIndex, type) {
            const newField = {
                id: `dynamic_field_${Date.now()}`,
                label: `Nuevo Campo ${type === 'select' || type === 'autofill-select' ? 'Lista' : (type === 'date-input' ? 'Fecha' : (type === 'textarea' ? 'Texto Largo' : 'Texto'))}`,
                type: type,
                required: false
            };
            if (type === 'select' || type === 'autofill-select') newField.options = ['Opci√≥n A', 'Opci√≥n B'];
            formStructure[secIndex].fields.push(newField);
            renderFormEditor();
        }

        function removeField(secIndex, fieldIndex) {
            // user-auto-fill al listado de campos fijos
            const isFixed = formStructure[secIndex].fields[fieldIndex].type === 'static' || 
                            formStructure[secIndex].fields[fieldIndex].type === 'ot_counter' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'date-auto' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'user-auto-fill';
            
            // La primera secci√≥n tiene los 4 campos fijos iniciales
            if (secIndex === 0 && isFixed) {
                alert("üö´ No se pueden eliminar los campos fijos y obligatorios de la primera secci√≥n.");
                return;
            }
            if (confirm('¬øEst√°s seguro de que quieres eliminar este campo?')) {
                formStructure[secIndex].fields.splice(fieldIndex, 1);
                renderFormEditor();
            }
        }


        // *** 5. L√ìGICA DE CREACI√ìN DE ORDEN DE TRABAJO ***
        
        // NUEVA FUNCI√ìN: Formatea fecha YYYY-MM-DD o DD/MM/YYYY a DD/MM/YYYY
        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return 'N/A';
            
            // Si la fecha ya est√° en formato DD/MM/YYYY, se asume que es la correcta (campos fijos)
            if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dateString;
            }

            // Para fechas YYYY-MM-DD (inputs de tipo date)
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const [year, month, day] = parts;
                return `${day}/${month}/${year}`;
            }

            // Si no coincide con ninguno, devuelve el original
            return dateString;
        }

        /**
         * Obtiene la fecha actual formateada para la zona horaria de Caracas (GMT-4).
         * @returns {string} Fecha en formato DD/MM/AAAA.
         */
        function getCurrentCaracasDate() {
            const now = new Date();
            // Usamos las opciones de formato y la zona horaria de Caracas para forzar la fecha GMT-4.
            return now.toLocaleDateString('es-ES', { timeZone: 'America/Caracas', day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        /**
         * Funci√≥n que autocompleta los campos de Responsable y Rif al cambiar la empresa.
         */
        function autofillContratistaData(selectElement) {
            const selectedCompanyName = selectElement.value;
            const data = CONTRATISTAS_DATA[selectedCompanyName];
            if (!data) {
                document.getElementById('Apellido y Nombre del Responsable').value = '';
                document.getElementById('Rif').value = '';
                return;
            }

            const responsibleField = document.getElementById('Apellido y Nombre del Responsable');
            const rifField = document.getElementById('Rif');
            
            if (responsibleField && data["Apellido y Nombre del Responsable"] !== undefined) {
                responsibleField.value = data["Apellido y Nombre del Responsable"];
            }
            if (rifField && data["Rif"] !== undefined) {
                rifField.value = data["Rif"];
            }
        }
        
        // FUNCI√ìN CORREGIDA: Ahora calcula correctamente ambos totales por separado
        function calculateNewTotal(prefix) {
            // C√°lculo para CANTV
            const precioUnitario = parseFloat(document.getElementById(`${prefix}_precio_unitario`).value.replace(',', '.')) || 0;
            const puntos = parseFloat(document.getElementById(`${prefix}_puntos`).value.replace(',', '.')) || 0;
            const total = precioUnitario * puntos;

            document.getElementById(`${prefix}_total_display`).textContent = total.toFixed(2);
            document.getElementById(`${prefix}_total_hidden`).value = total.toFixed(2);

            // C√°lculo para EDC (usando los campos con sufijo "1")
            const precioUnitario1 = parseFloat(document.getElementById(`${prefix}_precio_unitario1`).value.replace(',', '.')) || 0;
            const puntos1 = parseFloat(document.getElementById(`${prefix}_puntos1`).value.replace(',', '.')) || 0;
            const total1 = precioUnitario1 * puntos1;

            document.getElementById(`${prefix}_total_display1`).textContent = total1.toFixed(2);
            document.getElementById(`${prefix}_total_hidden1`).value = total1.toFixed(2);
        }

        function toggleConditionalSection(type) {
            const nodeAccessSection = document.getElementById('conditional_node_acceso_section');
            const ispSection = document.getElementById('conditional_isp_section');
            const nodeAccessButton = document.getElementById('check_node_acceso');
            const ispButton = document.getElementById('check_isp');

            // 1. Limpiar y resetear ambas secciones
            nodeAccessSection.style.display = 'none';
            ispSection.style.display = 'none';
            nodeAccessButton.classList.remove('active');
            ispButton.classList.remove('active');
            
            // 2. Resetear inputs y selecciones
            const fieldsToReset = ['costo_proyectado', 'precio_unitario', 'puntos', 'precio_unitario1', 'puntos1', 'descripcion', 'abono_mensual'];
            const selectsToReset = ['pago_por_realizado'];

            ['node_acceso', 'isp'].forEach(prefix => {
                 fieldsToReset.forEach(field => {
                    const el = document.getElementById(`${prefix}_${field}`);
                    if (el) el.value = '';
                });
                selectsToReset.forEach(field => {
                    const el = document.getElementById(`${prefix}_${field}`);
                    if (el) el.value = 'Inter'; // Valor por defecto
                });

                document.getElementById(`${prefix}_total_display`).textContent = '0.00';
                document.getElementById(`${prefix}_total_display1`).textContent = '0.00';
                document.getElementById(`${prefix}_total_hidden`).value = '0.00';
                document.getElementById(`${prefix}_total_hidden1`).value = '0.00';
            });


            // 3. Mostrar la secci√≥n seleccionada
            if (type === 'node_acceso') {
                nodeAccessSection.style.display = 'block';
                nodeAccessButton.classList.add('active');
            } else if (type === 'isp') {
                ispSection.style.display = 'block';
                ispButton.classList.add('active');
            }
        }
        
        function renderWorkOrderForm() {
            const formElement = document.getElementById('work-order-form');
            formElement.innerHTML = '';
            
            const todayCaracas = getCurrentCaracasDate();
            const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'USUARIO NO LOGUEADO'; // Obtener email

            if (!formStructure) {
                formElement.innerHTML = '<p>Cargando estructura del formulario...</p>';
                return;
            }

            // Renderizar secciones din√°micas
            formStructure.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `<h4>${section.title}</h4>`;

                section.fields.forEach(field => {
                    const requiredStar = field.required ? '<span style="color: var(--color-error); margin-left: 5px;">*</span>' : '';
                    let inputHTML = '';
                    let value = '';
                    let isDisabled = '';
                    let onChangeEvent = '';
                    let isAutofillField = false;

                    if (section.title.includes('II. Informaci√≥n de la Contratista')) {
                        const autofillKeys = ["Apellido y Nombre del Responsable", "Rif"];
                        if (autofillKeys.includes(field.label)) {
                            isDisabled = 'disabled';
                            isAutofillField = true;
                        } else if (field.type === 'autofill-select') {
                             onChangeEvent = `onchange="autofillContratistaData(this)"`;
                        }
                    }
                    
                    const fieldId = isAutofillField ? field.label : field.id;
                    const isFixedField = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill';
                    const requiredAttribute = field.required && !isFixedField ? 'required' : '';

                    switch (field.type) {
                        case 'static':
                            value = field.value;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'ot_counter':
                            value = otCounter;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        // TIPO DE CAMPO: user-auto-fill
                        case 'user-auto-fill':
                            value = currentUserEmail;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'date-auto':
                            value = todayCaracas;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'date-input':
                            inputHTML = `<input type="date" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`;
                            break;
                        case 'text':
                        case 'number':
                            inputHTML = `<input type="${field.type}" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`;
                            break;
                        case 'textarea':
                            inputHTML = `<textarea id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} style="min-height: 100px;"></textarea>`;
                            break;
                        case 'select':
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>`;
                            break;
                        case 'autofill-select':
                            const optionsHTML = Object.keys(CONTRATISTAS_DATA).map(key => `<option value="${key}">${key}</option>`).join('');
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                ${optionsHTML}
                            </select>`;
                            break;
                    }

                    sectionDiv.innerHTML += `<p><label for="${fieldId}">${field.label}${requiredStar}:</label>${inputHTML}</p>`;
                });

                formElement.appendChild(sectionDiv);
            });

            // A√ëADIR BOTONES DE CHECK CONDICIONAL AL FINAL
            formElement.innerHTML += `
                <h4>Tipo de Construcci√≥n (Selecci√≥n √önica)</h4>
                <button type="button" class="conditional-check" id="check_node_acceso" onclick="toggleConditionalSection('node_acceso')">
                    La Construcci√≥n es de un Nodo de Acceso
                </button>
                <button type="button" class="conditional-check" id="check_isp" onclick="toggleConditionalSection('isp')">
                    La Construcci√≥n es de un ISP
                </button>
                <button type="button" style="background-color: var(--color-error); color: var(--color-white); margin-top: 15px;" onclick="toggleConditionalSection(null)">
                    ‚ùå Eliminar / Desmarcar Selecci√≥n
                </button>
            `;

            // --- SECCI√ìN CONDICIONAL: CONSTRUCCI√ìN NODO DE ACCESO ---
            formElement.innerHTML += renderConditionalSection('node_acceso', 'Datos Condicionales: La Construcci√≥n es de Nodo de Acceso');

            // --- SECCI√ìN CONDICIONAL: CONSTRUCCI√ìN ISP ---
            formElement.innerHTML += renderConditionalSection('isp', 'Datos Condicionales: La Construcci√≥n es de un ISP');
            
            // Inicializar las secciones ocultas
            toggleConditionalSection(null);

            // Inicializar autollenado con el valor por defecto
            const autofillSelects = document.querySelectorAll('select[onchange="autofillContratistaData(this)"]');
            autofillSelects.forEach(select => autofillContratistaData(select));
        }

        // FUNCI√ìN ACTUALIZADA: Ahora incluye t√≠tulos separados para CANTV y EDC
        function renderConditionalSection(prefix, title) {
            const onChangeFunc = `calculateNewTotal('${prefix}')`;

            // El campo de Abono Mensual solo existe para ISP
            const abonoMensualField = prefix === 'isp' ? 
                 `<p><label for="${prefix}_abono_mensual">Abono Mensual (*):</label> 
                    <input type="number" step="0.01" min="0" id="${prefix}_abono_mensual" name="${prefix}_abono_mensual" required></p>` : '';


            return `
                <div class="form-section" id="conditional_${prefix}_section" style="display: none;">
                    <h4>${title}</h4>

                    <p><label for="${prefix}_costo_proyectado">Costo Proyectado de la Obra (*):</label> 
                        <input type="text" id="${prefix}_costo_proyectado" name="${prefix}_costo_proyectado" required></p>

                    <p><label for="${prefix}_pago_por_realizado">Pago realizado por (*):</label> 
                        <select id="${prefix}_pago_por_realizado" name="${prefix}_pago_por_realizado" required>
                            <option value="Inter">Inter</option>
                            <option value="Cliente">Cliente</option>
                        </select></p>
                    
                    ${abonoMensualField}

                    <hr>

                    <h5>Pago x VGT CANTV</h5>
                    <div class="calculation-group">
                        <label for="${prefix}_precio_unitario" class="calculation-input">Precio Unitario:</label>
                        <input type="number" step="0.01" min="0" id="${prefix}_precio_unitario" name="${prefix}_precio_unitario" oninput="${onChangeFunc}" class="calculation-input">
                        
                        <span class="formula-symbol">X</span>

                        <label for="${prefix}_puntos" class="calculation-input">Puntos:</label>
                        <input type="number" step="1" min="0" id="${prefix}_puntos" name="${prefix}_puntos" oninput="${onChangeFunc}" class="calculation-input">
                        
                        <div class="calculation-total-section">
                            <label>TOTAL CANTV:</label>
                            <span id="${prefix}_total_display" class="total-display">0.00</span>
                            <input type="hidden" id="${prefix}_total_hidden" name="${prefix}_total_hidden" value="0.00">
                        </div>
                    </div>
                    
                    <hr>

                    <h5>Pago x VGT EDC</h5>
                    <div class="calculation-group">
                        <label for="${prefix}_precio_unitario1" class="calculation-input">Precio Unitario:</label>
                        <input type="number" step="0.01" min="0" id="${prefix}_precio_unitario1" name="${prefix}_precio_unitario1" oninput="${onChangeFunc}" class="calculation-input">
                        
                        <span class="formula-symbol">X</span>

                        <label for="${prefix}_puntos1" class="calculation-input">Puntos:</label>
                        <input type="number" step="1" min="0" id="${prefix}_puntos1" name="${prefix}_puntos1" oninput="${onChangeFunc}" class="calculation-input">
                        
                        <div class="calculation-total-section">
                            <label>TOTAL EDC:</label>
                            <span id="${prefix}_total_display1" class="total-display">0.00</span>
                             <input type="hidden" id="${prefix}_total_hidden1" name="${prefix}_total_hidden1" value="0.00">
                        </div>
                    </div>

                    <p><label for="${prefix}_descripcion">Descripci√≥n del Trabajo (*):</label> 
                       <textarea id="${prefix}_descripcion" name="${prefix}_descripcion" required style="min-height: 150px;"></textarea></p>
                </div>
            `;
        }

        // FUNCI√ìN CORREGIDA PARA DESCARGA DE PDF
        /**
         * Funci√≥n principal para generar y guardar la Orden de Trabajo.
         */
        async function generateWorkOrder() {
            // 1. Obtener los datos del formulario
            const form = document.getElementById('work-order-form');
            if (!form.checkValidity()) {
                alert('‚ö†Ô∏è Por favor, complete todos los campos obligatorios antes de crear la orden.');
                form.reportValidity();
                return;
            }

            const otNumber = otCounter;
            const orderData = {};
            const formData = new FormData(form);
            
            // Recoger los datos fijos del encabezado (no est√°n en FormData)
            formStructure[0].fields.forEach(field => {
                let value = '';
                if (field.type === 'static') value = field.value;
                else if (field.type === 'ot_counter') value = otNumber;
                else if (field.type === 'date-auto') value = getCurrentCaracasDate();
                else if (field.type === 'user-auto-fill') value = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'USUARIO NO LOGUEADO';
                
                if (value !== '') {
                    orderData[field.label] = value;
                }
            });

            // Recoger los datos din√°micos (est√°n en FormData)
            for (let [key, value] of formData.entries()) {
                // El name/id del campo puede no ser un label amigable, as√≠ que usamos el label si lo encontramos.
                // Sin embargo, si es un campo de autollenado (Apellido/Rif) o total oculto, el name es el label.
                
                // Excluir los totales ocultos (se a√±aden despu√©s)
                if (key.endsWith('_total_hidden') || key.endsWith('_total_hidden1')) continue;
                
                let label = key;

                // Buscar el label amigable en la estructura (para campos din√°micos)
                let foundField = null;
                formStructure.some(section => 
                    section.fields.some(field => {
                        // Comprobar por ID (para campos din√°micos con ID √∫nico)
                        if (field.id === key) {
                            label = field.label;
                            foundField = field;
                            return true;
                        }
                        // Comprobar por Label (para campos autollenados con Label como ID/Name)
                        if (field.label === key) {
                            label = field.label;
                            foundField = field;
                            return true;
                        }
                        return false;
                    })
                );
                
                // Para campos de fecha, formatear el valor
                if (foundField && foundField.type === 'date-input') {
                    value = formatDateToDDMMYYYY(value);
                }
                
                orderData[label] = value;
            }

            // Recoger datos de secciones condicionales (Totales)
            const activePrefix = document.getElementById('conditional_node_acceso_section').style.display === 'block' ? 'node_acceso' : 
                                 document.getElementById('conditional_isp_section').style.display === 'block' ? 'isp' : null;

            if (activePrefix) {
                // Recuperar los valores de los inputs *ocultos* de total
                const totalCantv = document.getElementById(`${activePrefix}_total_hidden`).value;
                const totalEdc = document.getElementById(`${activePrefix}_total_hidden1`).value;

                orderData['Tipo de Obra'] = activePrefix === 'node_acceso' ? 'Nodo de Acceso' : 'ISP';
                orderData['Costo Proyectado de la Obra'] = document.getElementById(`${activePrefix}_costo_proyectado`).value;
                orderData['Pago realizado por'] = document.getElementById(`${activePrefix}_pago_por_realizado`).value;
                
                // Campos de CANTV
                orderData['CANTV - Precio Unitario'] = document.getElementById(`${activePrefix}_precio_unitario`).value;
                orderData['CANTV - Puntos'] = document.getElementById(`${activePrefix}_puntos`).value;
                orderData['CANTV - Total'] = totalCantv; // Usar el valor del input oculto
                
                // Campos de EDC
                orderData['EDC - Precio Unitario'] = document.getElementById(`${activePrefix}_precio_unitario1`).value;
                orderData['EDC - Puntos'] = document.getElementById(`${activePrefix}_puntos1`).value;
                orderData['EDC - Total'] = totalEdc; // Usar el valor del input oculto
                
                // Descripci√≥n (campo de √°rea de texto)
                orderData['Descripci√≥n del Trabajo'] = document.getElementById(`${activePrefix}_descripcion`).value;

                // Abono Mensual (solo ISP)
                if (activePrefix === 'isp') {
                     orderData['Abono Mensual'] = document.getElementById(`${activePrefix}_abono_mensual`).value;
                }
            } else {
                 orderData['Tipo de Obra'] = 'N/A (No seleccionado)';
            }
            
            // 2. Guardar en Firestore
            let tempElement; // Declarar fuera del try/catch
            try {
                // Generar un ID antes de guardar
                const newDocRef = ORDERS_COLLECTION.doc(); 
                await newDocRef.set(orderData);
                
                // 3. Incrementar el contador global y guardarlo
                otCounter++;
                await saveFormStructure(true); // Guardar nuevo contador sin alert

                // 4. Actualizar estado local
                workOrders.unshift({ id: newDocRef.id, ...orderData }); // A√±adir al inicio de la lista
                renderOrdersTable(); // Actualizar la tabla

                // 5. Generar PDF (AQU√ç EST√Å LA CORRECCI√ìN CLAVE)
                // A. Crear el contenido HTML del PDF
                const pdfContent = generatePDFContentHTML(orderData);
                const otFileName = `OT_Nro_${otNumber}_${orderData['T√≠tulo del Formulario'] || 'Orden'}.pdf`;

                // B. Elemento temporal para html2pdf
                tempElement = document.createElement('div');
                tempElement.innerHTML = pdfContent;
                
                // ** CORRECCI√ìN: Agregar temporalmente el elemento al DOM para que html2canvas funcione **
                tempElement.style.position = 'absolute';
                tempElement.style.left = '-9999px'; // Mover fuera de la vista
                document.body.appendChild(tempElement); 

                // C. Configuraci√≥n y ejecuci√≥n de html2pdf
                const options = {
                    margin: 10,
                    filename: otFileName,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // La funci√≥n html2pdf recibe el *elemento* DOM
                await html2pdf().from(tempElement).set(options).save(); 
                
                // ** CORRECCI√ìN: Eliminar el elemento del DOM una vez que la generaci√≥n haya terminado **
                document.body.removeChild(tempElement); 

                alert(`üéâ Orden de Trabajo Nro. ${otNumber} creada y guardada exitosamente. Se ha descargado el PDF.`);
                
                // Limpiar el formulario y re-renderizar
                form.reset();
                renderWorkOrderForm();

            } catch (error) {
                console.error("Error al crear y guardar la orden o generar PDF:", error);
                alert("üî¥ Error al crear la Orden de Trabajo o generar el PDF. Detalles: " + error.message);
                
                // Asegurar que se elimine el elemento incluso si falla
                 if (tempElement && document.body.contains(tempElement)) {
                    document.body.removeChild(tempElement);
                }
            }
        }


        // *** 6. L√ìGICA DE VISUALIZACI√ìN Y PDF (√ìRDENES CREADAS) ***

        /**
         * Renderiza la tabla de √≥rdenes de trabajo.
         */
        function renderOrdersTable() {
            const tableBody = document.querySelector('#orders-table tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            // Determinar si el usuario tiene permiso para generar el PDF (Admin/Normal)
            const canGeneratePdf = (currentRole === 'admin' || currentRole === 'normal');

            workOrders.forEach(order => {
                const otNumber = order['Orden de Trabajo'] || 'N/A';
                const otTitle = order['T√≠tulo del Formulario'] || 'Orden de Trabajo';
                const otDate = order['Fecha Actual'] || 'N/A';
                
                let actionButton = '';
                if (canGeneratePdf) {
                    actionButton = `<button onclick="viewOrderDetails('${order.id}')">Descargar PDF</button>`;
                } else {
                    actionButton = `<span>Solo Vista</span>`;
                }

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${otNumber}</td>
                    <td>${otTitle}</td>
                    <td>${otDate}</td>
                    <td>${actionButton}</td>
                `;
            });
        }
        
        // FUNCI√ìN CORREGIDA PARA DESCARGA DE PDF DE √ìRDENES EXISTENTES
        /**
         * Muestra los detalles de una orden espec√≠fica y genera su PDF.
         * @param {string} orderId - El ID de la orden.
         */
        async function viewOrderDetails(orderId) {
            const order = workOrders.find(o => o.id === orderId);
            if (!order) {
                alert("Orden no encontrada.");
                return;
            }

            // 1. Crear el contenido HTML del PDF
            const pdfContent = generatePDFContentHTML(order);
            const otNumber = order['Orden de Trabajo'] || 'N-A';
            const otFileName = `OT_Nro_${otNumber}_${order['T√≠tulo del Formulario'] || 'Orden'}.pdf`;

            // 2. Elemento temporal para html2pdf
            const tempElement = document.createElement('div');
            tempElement.innerHTML = pdfContent;

            // 3. Configuraci√≥n y ejecuci√≥n de html2pdf
            const options = {
                margin: 10,
                filename: otFileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                // ** CORRECCI√ìN: Agregar temporalmente el elemento al DOM para que html2canvas funcione **
                tempElement.style.position = 'absolute';
                tempElement.style.left = '-9999px'; 
                document.body.appendChild(tempElement);
                
                await html2pdf().from(tempElement).set(options).save();
                
                // ** CORRECCI√ìN: Eliminar el elemento del DOM una vez que la generaci√≥n haya terminado **
                document.body.removeChild(tempElement); 
                
                alert(`‚úÖ PDF de la Orden Nro. ${otNumber} generado y descargado.`);

            } catch (error) {
                console.error("Error al generar PDF:", error);
                alert("üî¥ Error al generar el PDF. Detalles: " + error.message);
                // Asegurar que se elimine el elemento incluso si falla
                 if (document.body.contains(tempElement)) {
                    document.body.removeChild(tempElement);
                }
            }
        }

        /**
         * Genera el contenido HTML para el PDF.
         * @param {Object} data - Objeto con los datos de la orden.
         * @returns {string} - Cadena HTML.
         */
        function generatePDFContentHTML(data) {
            // Funci√≥n auxiliar para formatear la fecha a DD/MM/AAAA para el PDF
            function formatPdfDate(dateString) {
                if (!dateString) return '';
                // Asume que la fecha guardada en Firestore ya est√° en formato DD/MM/AAAA
                return dateString;
            }
            
            // Funci√≥n auxiliar para generar las filas de la tabla de detalles
            function generateDetailRows() {
                let html = '';
                let sectionTitle = '';
                
                // Orden de presentaci√≥n de campos fijos
                const fieldOrder = [
                    'T√≠tulo del Formulario', 
                    'Orden de Trabajo', 
                    'Usuario que Crea la Orden', 
                    'Fecha Actual'
                ];
                
                // Obtener todas las claves (labels) de los datos, excluyendo el ID
                const allKeys = Object.keys(data).filter(key => key !== 'id').sort();

                // Unir campos fijos, din√°micos y totales para la presentaci√≥n en el PDF
                const keysToDisplay = [
                    ...fieldOrder.filter(key => allKeys.includes(key)), // Fijos primero
                    ...allKeys.filter(key => !fieldOrder.includes(key)) // El resto
                ];
                
                // Agrupaci√≥n manual de secciones (basada en la estructura esperada del formulario)
                const sectionsMap = {
                    "I. Informaci√≥n General": fieldOrder,
                    "II. Informaci√≥n de la Contratista": ["Nombre de la Empresa", "Raz√≥n Social", "Rif", "Apellido y Nombre del Responsable", "Tel√©fono de Contacto"],
                    "III. Informaci√≥n del Trabajo/Obra (B√°sico)": ["Sector/Urbanizaci√≥n", "Domicilio", "Punto de Referencia"],
                    "IV. Tipo y Costos de la Obra": ["Tipo de Obra", "Costo Proyectado de la Obra", "Pago realizado por", "Abono Mensual"],
                    "V. Detalles de VGT (CANTV/EDC)": ["CANTV - Precio Unitario", "CANTV - Puntos", "CANTV - Total", "EDC - Precio Unitario", "EDC - Puntos", "EDC - Total"],
                    "VI. Descripci√≥n del Trabajo": ["Descripci√≥n del Trabajo"]
                };
                
                let currentSection = '';
                
                keysToDisplay.forEach(key => {
                    const value = data[key];
                    if (value === undefined) return; 

                    // Determinar a qu√© secci√≥n pertenece la clave actual
                    let foundSection = '';
                    for (const [title, keys] of Object.entries(sectionsMap)) {
                        if (keys.includes(key)) {
                            foundSection = title;
                            break;
                        }
                    }

                    // Si la secci√≥n cambia, agregar el t√≠tulo de la nueva secci√≥n
                    if (foundSection && foundSection !== currentSection) {
                        html += `<tr><td colspan="2" style="background-color: #ADD8E6; font-weight: bold; padding: 8px; border-top: 2px solid #36454F;">${foundSection}</td></tr>`;
                        currentSection = foundSection;
                    }


                    // Formateo de valores num√©ricos/monetarios
                    let displayValue = value;
                    if (key.includes('Precio Unitario') || key.includes('Total') || key.includes('Costo Proyectado') || key.includes('Abono Mensual')) {
                         // Asume que son n√∫meros y los formatea como moneda
                         const numValue = parseFloat(value);
                         if (!isNaN(numValue)) {
                             // Intenta usar el formato monetario venezolano, si no, usa el formato general.
                             try {
                                displayValue = numValue.toLocaleString('es-VE', { style: 'currency', currency: 'VES' });
                             } catch (e) {
                                displayValue = numValue.toFixed(2) + ' VES';
                             }
                         }
                    } else if (key === 'Fecha Actual') {
                        displayValue = formatPdfDate(value);
                    } else if (key === 'Descripci√≥n del Trabajo' || key === 'Domicilio' || key === 'Punto de Referencia') {
                         // Para √°reas de texto o campos largos, se usan filas completas
                         html += `<tr><td style="font-weight: bold; width: 30%; border-right: none;">${key}:</td><td style="border-left: none;"></td></tr>`;
                         html += `<tr><td colspan="2" style="white-space: pre-wrap; padding: 10px; border-top: none; background-color: #f7fbff;">${displayValue}</td></tr>`;
                         return; // Saltar el formato de fila normal
                    }
                    
                    // Fila normal para el resto de los campos
                    if (key !== 'Descripci√≥n del Trabajo') {
                        html += `
                            <tr>
                                <td style="font-weight: bold; width: 30%;">${key}:</td>
                                <td>${displayValue}</td>
                            </tr>
                        `;
                    }
                });

                return html;
            }


            // Estructura del PDF. Se utilizan estilos en l√≠nea para asegurar la consistencia.
            return `
                <div style="padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #36454F; font-size: 10pt;">
                    <div style="text-align: center; border-bottom: 2px solid #ADD8E6; padding-bottom: 10px; margin-bottom: 20px;">
                        <h1 style="margin: 0; color: #36454F;">INTERCABLE | ORDEN DE TRABAJO NRO. ${data['Orden de Trabajo'] || 'N/A'}</h1>
                        <p style="margin: 5px 0 0 0; font-size: 1.1em; font-weight: bold;">${data['T√≠tulo del Formulario'] || 'Detalle'}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background-color: #ADD8E6;">
                                <th colspan="2" style="padding: 10px; text-align: left; font-size: 1.2em; border: 1px solid #B0C4DE;">Detalles de la Orden</th>
                            </tr>
                        </thead>
                        <tbody style="border: 1px solid #B0C4DE;">
                            ${generateDetailRows()}
                        </tbody>
                    </table>

                    <div class="pdf-signatures">
                        <span>
                            <hr style="width: 80%; margin: 10px auto 0 auto;">
                            Firma del Contratista
                        </span>
                        <span>
                            <hr style="width: 80%; margin: 10px auto 0 auto;">
                            Firma del Supervisor Intercable
                        </span>
                    </div>

                    <p style="text-align: center; margin-top: 50px; font-size: 0.8em; color: #555;">
                        Documento generado el ${formatPdfDate(data['Fecha Actual'])} por ${data['Usuario que Crea la Orden'] || 'Sistema'}
                    </p>
                </div>
            `;
        }


        /**
         * Asegura que el contador de OT sea siempre mayor que el mayor n√∫mero de OT existente.
         */
        function recalculateOtCounter() {
            let maxOt = 0;
            workOrders.forEach(order => {
                const ot = parseInt(order['Orden de Trabajo']);
                if (!isNaN(ot) && ot > maxOt) {
                    maxOt = ot;
                }
            });
            // El contador debe ser al menos 1 m√°s que el n√∫mero m√°ximo encontrado
            if (maxOt >= otCounter) {
                otCounter = maxOt + 1;
            }
        }
        
        /**
         * Funci√≥n administrativa para limpiar √≥rdenes duplicadas (solo visible para admin).
         */
        async function cleanDuplicateOrders() {
            if (currentRole !== 'admin') {
                alert("üö´ Permiso denegado.");
                return;
            }

            if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro de que deseas ejecutar la limpieza de √≥rdenes duplicadas? Esto eliminar√° las copias antiguas, manteniendo solo la m√°s reciente por n√∫mero de OT.")) {
                return;
            }

            try {
                // 1. Obtener todas las √≥rdenes
                const ordersSnapshot = await ORDERS_COLLECTION.get();
                const allOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 2. Agrupar por n√∫mero de OT
                const ordersByOt = allOrders.reduce((acc, order) => {
                    const otNumber = order['Orden de Trabajo'];
                    if (otNumber) {
                        if (!acc[otNumber]) {
                            acc[otNumber] = [];
                        }
                        acc[otNumber].push(order);
                    }
                    return acc;
                }, {});

                // 3. Identificar duplicados (m√°s de un documento por n√∫mero de OT)
                const duplicates = new Map(Object.entries(ordersByOt).filter(([ot, orders]) => orders.length > 1));
                
                if (duplicates.size === 0) {
                     alert("‚úÖ No se encontraron √≥rdenes duplicadas por n√∫mero de OT.");
                     return;
                }

                // 4. Eliminar duplicados (mantener el m√°s reciente por fecha de creaci√≥n)
                let deletedCount = 0;
                for (const [otNumber, orders] of duplicates) {
                    // Ordenar por fecha (mantener el m√°s reciente)
                    const sorted = orders.sort((a, b) => {
                        // Intentar parsear la fecha de DD/MM/AAAA. Si falla, usar 0 o Date.now()
                        const parseDate = (dateStr) => {
                             if (!dateStr || typeof dateStr !== 'string') return 0;
                             const parts = dateStr.split('/');
                             if (parts.length === 3) {
                                // M-D-Y format for new Date()
                                 return new Date(`${parts[1]}/${parts[0]}/${parts[2]}`); 
                             }
                             return 0;
                        };
                        
                        const dateA = parseDate(a['Fecha Actual']);
                        const dateB = parseDate(b['Fecha Actual']);
                        
                        // Si las fechas son v√°lidas, ordenar por fecha descendente
                        if (dateA && dateB) return dateB - dateA;
                        // Si no tienen fecha v√°lida, ordenar por ID (que contiene el timestamp de creaci√≥n)
                        return b.id.localeCompare(a.id);
                    });
                    
                    // Eliminar todos excepto el primero (m√°s reciente)
                    for (let i = 1; i < sorted.length; i++) {
                        await ORDERS_COLLECTION.doc(sorted[i].id).delete();
                        deletedCount++;
                        console.log(`Eliminada orden duplicada: ${otNumber} - ID: ${sorted[i].id}`);
                    }
                }
                
                alert(`Se eliminaron ${deletedCount} √≥rdenes duplicadas. Recargue la p√°gina para ver los cambios.`);
                
                // Recargar datos
                await loadInitialData();
                renderOrdersTable();
                renderWorkOrderForm();
                
            } catch (error) {
                console.error('Error limpiando duplicados:', error);
                alert('Error al limpiar duplicados: ' + error.message);
            }
        }

    </script>

</body>
</html>
