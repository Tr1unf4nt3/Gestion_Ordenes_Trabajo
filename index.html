<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition (Seguro)</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* [MANTENER TODOS LOS ESTILOS EXISTENTES...] */

        /* NUEVOS ESTILOS PARA ESTADOS Y CERTIFICACI√ìN */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-en-curso {
            background-color: var(--color-warning);
            color: var(--color-white);
        }
        
        .status-finalizada {
            background-color: var(--color-success);
            color: var(--color-white);
        }
        
        .certification-form {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .certification-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .back-button {
            background-color: var(--color-secondary);
        }
        
        .finalize-button {
            background-color: var(--color-success);
            color: var(--color-white);
        }
        
        .view-certificate-button {
            background-color: var(--color-primary);
            color: var(--color-white);
        }
    </style>
</head>
<body>

    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tab">
            <button class="tablinks" id="new-order-tab-button" onclick="openTab(event, 'new-order')">üìã Nueva Orden de Trabajo</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes Creadas</button>
            <!-- NUEVA PESTA√ëA: √ìrdenes Finalizadas -->
            <button class="tablinks" onclick="openTab(event, 'completed-orders')">‚úÖ √ìrdenes Finalizadas</button>
            <button class="tablinks" id="edit-tab-button" onclick="openTab(event, 'edit-form')" style="display: none;">‚öôÔ∏è Edici√≥n de Formulario</button>
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Contenido de las Pesta√±as -->

        <!-- Pesta√±a 1: Creaci√≥n de Orden de Trabajo -->
        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <!-- Pesta√±a 2: Visualizaci√≥n de √ìrdenes de Trabajo -->
        <div id="view-orders" class="tabcontent">
            <h3>Registro Hist√≥rico de √ìrdenes</h3>
            
            <!-- Filtros Din√°micos -->
            <div class="filters-section">
                <h4>üîç Filtros de B√∫squeda</h4>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="filter-field">Campo a filtrar:</label>
                        <select id="filter-field" onchange="updateFilterInput()">
                            <option value="">Seleccionar campo...</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-operator">Tipo de filtro:</label>
                        <select id="filter-operator" onchange="updateFilterInput()">
                            <option value="contains">Contiene texto</option>
                            <option value="equals">Es igual a</option>
                            <option value="startsWith">Comienza con</option>
                            <option value="endsWith">Termina con</option>
                            <option value="range">Rango</option>
                            <option value="greater">Mayor que</option>
                            <option value="less">Menor que</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="filter-value-container">
                        <label for="filter-value">Valor:</label>
                        <input type="text" id="filter-value" placeholder="Texto a buscar...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-button" onclick="addFilter()">‚ûï Agregar Filtro</button>
                        <button class="filter-button" onclick="clearAllFilters()" style="background-color: var(--color-error);">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                
                <div id="active-filters" class="active-filters" style="display: none;">
                    <strong>Filtros activos:</strong>
                    <div id="active-filters-list"></div>
                </div>
            </div>
            
            <table id="orders-table">
                <thead>
                    <tr>
                        <th>Nro. OT</th>
                        <th>T√≠tulo</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div id="no-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                <p>No se encontraron √≥rdenes que coincidan con los filtros aplicados.</p>
            </div>
        </div>

        <!-- NUEVA PESTA√ëA: √ìrdenes Finalizadas -->
        <div id="completed-orders" class="tabcontent">
            <h3>√ìrdenes Finalizadas</h3>
            
            <!-- Filtros para √ìrdenes Finalizadas -->
            <div class="filters-section">
                <h4>üîç Filtros de B√∫squeda</h4>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="completed-filter-field">Campo a filtrar:</label>
                        <select id="completed-filter-field" onchange="updateCompletedFilterInput()">
                            <option value="">Seleccionar campo...</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="completed-filter-operator">Tipo de filtro:</label>
                        <select id="completed-filter-operator" onchange="updateCompletedFilterInput()">
                            <option value="contains">Contiene texto</option>
                            <option value="equals">Es igual a</option>
                            <option value="startsWith">Comienza con</option>
                            <option value="endsWith">Termina con</option>
                            <option value="range">Rango</option>
                            <option value="greater">Mayor que</option>
                            <option value="less">Menor que</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="completed-filter-value-container">
                        <label for="completed-filter-value">Valor:</label>
                        <input type="text" id="completed-filter-value" placeholder="Texto a buscar...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-button" onclick="addCompletedFilter()">‚ûï Agregar Filtro</button>
                        <button class="filter-button" onclick="clearCompletedFilters()" style="background-color: var(--color-error);">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                
                <div id="completed-active-filters" class="active-filters" style="display: none;">
                    <strong>Filtros activos:</strong>
                    <div id="completed-active-filters-list"></div>
                </div>
            </div>
            
            <table id="completed-orders-table">
                <thead>
                    <tr>
                        <th>Nro. OT</th>
                        <th>T√≠tulo</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Fecha Finalizaci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div id="completed-no-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                <p>No se encontraron √≥rdenes finalizadas que coincidan con los filtros aplicados.</p>
            </div>
        </div>

        <!-- Pesta√±a 3: Edici√≥n de Formulario (Solo Administrador) -->
        <div id="edit-form" class="tabcontent">
            <h3>Edici√≥n de Formulario</h3>
            <div id="form-editor"></div>
            <button onclick="saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>
            <button onclick="cleanDuplicateOrders()" style="background-color: var(--color-error); color: white; margin-left: 10px;">üßπ Limpiar Duplicados</button>
            
            <!-- Respaldo y Restauraci√≥n de Base de Datos -->
            <div class="backup-section">
                <h4>üîÑ Respaldo y Restauraci√≥n de Base de Datos</h4>
                <p>Estas funciones permiten exportar e importar toda la informaci√≥n del sistema para realizar respaldos o migraciones.</p>
                
                <div class="backup-buttons">
                    <button class="backup-button" onclick="exportDatabase()">üì§ Exportar Base de Datos</button>
                    <button class="backup-button" onclick="document.getElementById('import-file').click()">üì• Importar Base de Datos</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importDatabase(this.files[0])">
                </div>
                
                <p style="font-size: 0.9em; margin-top: 15px; color: var(--color-warning);">
                    <strong>Nota:</strong> La importaci√≥n reemplazar√° todos los datos actuales en la base de datos. 
                    Aseg√∫rese de tener un respaldo reciente antes de realizar esta operaci√≥n.
                </p>
            </div>
        </div>

        <!-- NUEVA PESTA√ëA: Formulario de Certificaci√≥n -->
        <div id="certification-form" class="tabcontent" style="display: none;">
            <h3>Certificaci√≥n de Obra</h3>
            <div class="certification-form">
                <form id="certification-work-form">
                    <!-- El contenido se genera din√°micamente -->
                </form>
                <div class="certification-actions">
                    <button class="back-button" onclick="goBackToOrders()">‚¨ÖÔ∏è Atr√°s</button>
                    <button class="finalize-button" onclick="generateCertification()">‚úÖ Generar Certificaci√≥n</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
        
        // ** CONFIGURACI√ìN DE FIREBASE ACTUALIZADA **
        const firebaseConfig = {
          apiKey: "AIzaSyC40g7AnTbn2mtamOx_siPhckajgNCjZmg",
          authDomain: "gestionordenestrabajo.firebaseapp.com",
          projectId: "gestionordenestrabajo",
          storageBucket: "gestionordenestrabajo.firebasestorage.app",
          messagingSenderId: "478774861151",
          appId: "1:478774861151:web:e956dca23988e5d8fceaea"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Referencias a las "colecciones" de la base de datos
        const ORDERS_COLLECTION = db.collection("workOrders");
        const CONFIG_COLLECTION = db.collection("config"); 
        const CERTIFICATIONS_COLLECTION = db.collection("certifications"); // NUEVA COLECCI√ìN
        
        // Variables de estado
        let formStructure = null; 
        let workOrders = []; 
        let otCounter = 1; 
        let currentRole = null; 
        let activeFilters = [];
        let completedFilters = []; // NUEVO: Filtros para √≥rdenes finalizadas
        let currentOrderForCertification = null; // NUEVO: Orden actual para certificaci√≥n

        // Estructura del formulario de certificaci√≥n
        const CERTIFICATION_FORM_STRUCTURE = [
            { 
                title: "I. Datos de Certificaci√≥n", 
                fields: [
                    { id: "certification_number", label: "N√∫mero de Certificaci√≥n", type: "static", value: "", required: true },
                    { id: "certification_date", label: "Fecha", type: "date-auto", required: true }
                ]
            },
            { 
                title: "II. Identificaci√≥n", 
                fields: [
                    { id: "certification_empresa", label: "Empresa", type: "static", value: "", required: true },
                    { id: "certification_responsable", label: "Apellido y Nombre del Responsable", type: "static", value: "", required: true },
                    { id: "certification_rif", label: "Rif", type: "static", value: "", required: true }
                ]
            },
            { 
                title: "III. Informaci√≥n del Proyecto", 
                fields: [
                    { id: "certification_reference", label: "Referencia Orden de Trabajo", type: "static", value: "", required: true },
                    { id: "start_date", label: "Fecha de Inicio", type: "date-input", required: true },
                    { id: "end_date", label: "Fecha de finalizaci√≥n", type: "date-input", required: true }
                ]
            },
            { 
                title: "IV. Detalle de los trabajos", 
                fields: [
                    { id: "conceptos_ejecutados", label: "Conceptos Ejecutados en el per√≠odo de tiempo", type: "textarea", required: true },
                    { id: "total_acreditado", label: "Total Acreditado en Certificaci√≥n", type: "text", required: true },
                    { id: "porcentaje_presupuesto", label: "Porcentaje sobre el presupuesto total", type: "text", required: true },
                    { id: "importe_final", label: "Importe final acreditado en la construcci√≥n", type: "text", required: true }
                ]
            },
            { 
                title: "V. Desviaciones y Justificaci√≥n", 
                fields: [
                    { id: "desviaciones_justificacion", label: "Desviaciones y Justificaci√≥n", type: "textarea", required: true }
                ]
            }
        ];

        // [MANTENER TODAS LAS FUNCIONES EXISTENTES HASTA initializeApp...]

        // MODIFICADA: Control de visibilidad de pesta√±as para los 3 roles
        async function initializeApp(role) {
            const isCreator = (role === 'admin' || role === 'normal');

            document.getElementById('edit-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
            document.getElementById('new-order-tab-button').style.display = isCreator ? 'inline-block' : 'none';
            
            await loadInitialData(); 
            
            if (role === 'admin') {
                renderFormEditor();
                openTab(null, 'edit-form');
            } else if (role === 'normal') {
                openTab(null, 'new-order');
            } else if (role === 'viewer') {
                openTab(null, 'view-orders'); 
            }
            
            renderWorkOrderForm();
            renderOrdersTable();
            renderCompletedOrdersTable(); // NUEVO: Renderizar tabla de √≥rdenes finalizadas
        }

        // MODIFICADA: Incluye nueva pesta√±a de certificaci√≥n
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            // Si es la pesta√±a de certificaci√≥n, no activar el tablink
            if (tabName !== 'certification-form') {
                document.getElementById(tabName).style.display = "block";
                if (evt) evt.currentTarget.className += " active";
            } else {
                document.getElementById(tabName).style.display = "block";
            }

            if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
            else if (tabName === 'view-orders') {
                renderOrdersTable();
                initializeFilters();
            }
            else if (tabName === 'completed-orders') {
                renderCompletedOrdersTable();
                initializeCompletedFilters(); // NUEVO: Inicializar filtros para √≥rdenes finalizadas
            }
            else if (tabName === 'edit-form' && currentRole === 'admin' && formStructure) renderFormEditor();
            else if (tabName === 'certification-form' && currentOrderForCertification) {
                renderCertificationForm();
            }
        }

        // [MANTENER TODAS LAS FUNCIONES EXISTENTES HASTA generateWorkOrder...]

        // MODIFICADA: Agregar estado por defecto "En Curso"
        async function generateWorkOrder() {
            // [MANTENER TODA LA L√ìGICA EXISTENTE DE VALIDACI√ìN...]

            // 6. **GUARDAR EN FIREBASE**
            console.log("Datos a guardar en Firebase:", orderData);
            
            try {
                // AGREGAR ESTADO POR DEFECTO
                orderData.estado = "En Curso";
                orderData.fecha_creacion = new Date().toISOString();
                
                const docRef = await ORDERS_COLLECTION.add(orderData); 
                
                // 7. Actualizar array local y contador
                orderData.id = docRef.id; 
                workOrders.push(orderData);
                otCounter++;
                
                // 8. Guardar la nueva estructura/contador
                await saveFormStructure(true); 

                // 9. Generar PDF
                console.log('Generando PDF para nueva orden...');
                await generatePDF(orderData);
                console.log('PDF generado exitosamente');

                // 10. Reiniciar UI
                document.getElementById('work-order-form').reset();
                renderWorkOrderForm(); 
                renderOrdersTable(); 
                
                alert('‚úÖ Orden de Trabajo creada exitosamente y PDF generado.');
                
            } catch (e) {
                console.error("Error al crear la orden:", e);
                // [MANTENER MANEJO DE ERRORES...]
            }
        }

        // NUEVA FUNCI√ìN: Renderizar formulario de certificaci√≥n
        function renderCertificationForm() {
            const formElement = document.getElementById('certification-work-form');
            formElement.innerHTML = '';
            
            if (!currentOrderForCertification) {
                formElement.innerHTML = '<p>Error: No se encontr√≥ la orden de trabajo.</p>';
                return;
            }

            const todayCaracas = getCurrentCaracasDate();

            CERTIFICATION_FORM_STRUCTURE.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `<h4>${section.title}</h4>`;

                section.fields.forEach(field => {
                    const requiredStar = field.required ? '<span style="color: var(--color-error); margin-left: 5px;">*</span>' : '';
                    let inputHTML = '';
                    let value = '';

                    // Llenar campos est√°ticos con datos de la orden
                    if (field.type === 'static') {
                        switch (field.id) {
                            case 'certification_number':
                                value = currentOrderForCertification['Orden de Trabajo'] || '';
                                break;
                            case 'certification_empresa':
                                value = currentOrderForCertification['Empresa'] || '';
                                break;
                            case 'certification_responsable':
                                value = currentOrderForCertification['Apellido y Nombre del Responsable'] || '';
                                break;
                            case 'certification_rif':
                                value = currentOrderForCertification['Rif'] || '';
                                break;
                            case 'certification_reference':
                                value = currentOrderForCertification['Orden de Trabajo'] || '';
                                break;
                        }
                        inputHTML = `<input type="text" value="${value}" disabled>`;
                    } else if (field.type === 'date-auto') {
                        value = todayCaracas;
                        inputHTML = `<input type="text" value="${value}" disabled>`;
                    } else {
                        const requiredAttribute = field.required ? 'required' : '';
                        if (field.type === 'textarea') {
                            inputHTML = `<textarea id="${field.id}" name="${field.id}" ${requiredAttribute} style="min-height: 100px;"></textarea>`;
                        } else if (field.type === 'date-input') {
                            inputHTML = `<input type="date" id="${field.id}" name="${field.id}" ${requiredAttribute}>`;
                        } else {
                            inputHTML = `<input type="${field.type}" id="${field.id}" name="${field.id}" ${requiredAttribute}>`;
                        }
                    }

                    sectionDiv.innerHTML += `<p><label for="${field.id}">${field.label}${requiredStar}:</label>${inputHTML}</p>`;
                });
                formElement.appendChild(sectionDiv);
            });

            // Agregar secci√≥n de firmas
            const signaturesDiv = document.createElement('div');
            signaturesDiv.className = 'form-section';
            signaturesDiv.innerHTML = `
                <h4>Firmas</h4>
                <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                    <div style="text-align: center; width: 45%;">
                        <p><strong>Firma Gerente T√©cnico:</strong></p>
                        <div style="border-bottom: 1px solid #000; margin-top: 60px; padding: 10px;"></div>
                    </div>
                    <div style="text-align: center; width: 45%;">
                        <p><strong>Firma Jefe T√©cnico:</strong></p>
                        <div style="border-bottom: 1px solid #000; margin-top: 60px; padding: 10px;"></div>
                    </div>
                </div>
            `;
            formElement.appendChild(signaturesDiv);
        }

        // NUEVA FUNCI√ìN: Abrir formulario de certificaci√≥n
        function openCertificationForm(orderId) {
            const order = workOrders.find(o => o.id === orderId);
            if (order) {
                currentOrderForCertification = order;
                openTab(null, 'certification-form');
            } else {
                alert('Error: No se encontr√≥ la orden de trabajo.');
            }
        }

        // NUEVA FUNCI√ìN: Volver a √≥rdenes desde certificaci√≥n
        function goBackToOrders() {
            currentOrderForCertification = null;
            openTab(null, 'view-orders');
        }

        // NUEVA FUNCI√ìN: Generar certificaci√≥n
        async function generateCertification() {
            const form = document.getElementById('certification-work-form');
            const formData = new FormData(form);
            
            // Validar campos requeridos
            let firstInvalidField = null;
            CERTIFICATION_FORM_STRUCTURE.forEach(section => {
                section.fields.forEach(field => {
                    if (field.required && field.type !== 'static' && field.type !== 'date-auto') {
                        const inputElement = document.getElementById(field.id);
                        if (inputElement && !inputElement.checkValidity()) {
                            if (!firstInvalidField) firstInvalidField = inputElement;
                        }
                    }
                });
            });

            if (firstInvalidField) {
                alert('‚ö†Ô∏è Atenci√≥n: Debe completar todos los campos obligatorios marcados con (*).');
                firstInvalidField.reportValidity();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
                return;
            }

            // Recopilar datos del formulario
            const certificationData = {
                orderId: currentOrderForCertification.id,
                orderNumber: currentOrderForCertification['Orden de Trabajo'],
                fecha_creacion: new Date().toISOString(),
                certificacion_completa: true
            };

            CERTIFICATION_FORM_STRUCTURE.forEach(section => {
                section.fields.forEach(field => {
                    if (field.type === 'static' || field.type === 'date-auto') {
                        const inputElement = document.getElementById(field.id);
                        certificationData[field.id] = inputElement ? inputElement.value : '';
                    } else {
                        certificationData[field.id] = formData.get(field.id) || '';
                    }
                });
            });

            try {
                // Guardar certificaci√≥n en Firebase
                await CERTIFICATIONS_COLLECTION.add(certificationData);
                
                // Actualizar estado de la orden a "Finalizada"
                await ORDERS_COLLECTION.doc(currentOrderForCertification.id).update({
                    estado: "Finalizada",
                    fecha_finalizacion: new Date().toISOString()
                });

                // Actualizar datos locales
                const orderIndex = workOrders.findIndex(o => o.id === currentOrderForCertification.id);
                if (orderIndex !== -1) {
                    workOrders[orderIndex].estado = "Finalizada";
                    workOrders[orderIndex].fecha_finalizacion = new Date().toISOString();
                }

                // Generar PDF de certificaci√≥n
                await generateCertificationPDF(certificationData);

                alert('‚úÖ Certificaci√≥n generada exitosamente y orden marcada como finalizada.');
                
                // Volver a la vista de √≥rdenes
                goBackToOrders();
                
            } catch (error) {
                console.error('Error al generar certificaci√≥n:', error);
                alert('Error al generar la certificaci√≥n: ' + error.message);
            }
        }

        // NUEVA FUNCI√ìN: Generar PDF de certificaci√≥n
        function generateCertificationPDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    const fileName = `Certificacion_Obra_${data.orderNumber}_${getCurrentCaracasDate().replace(/\//g, '-')}.pdf`;
                    
                    const printContainer = document.createElement('div');
                    printContainer.id = 'certification-pdf-print-container';
                    printContainer.style.cssText = `
                        position: absolute;
                        left: -9999px;
                        top: 0;
                        width: 190mm;
                        min-height: 277mm;
                        background: white;
                        padding: 10mm;
                        font-family: Arial, sans-serif;
                        box-sizing: border-box;
                        line-height: 1.4;
                        font-size: 12px;
                    `;

                    let certificationHTML = `
                        <div style="font-family: 'Arial', sans-serif; color: #36454F; line-height: 1.4; width: 100%;">
                            <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px;">
                                Certificaci√≥n de Obra - Nro. ${data.certification_number}
                            </h1>
                            
                            <div style="text-align: right; margin-bottom: 25px; font-weight: bold; color: #555; font-size: 12px;">
                                Fecha de Emisi√≥n: ${data.certification_date}
                            </div>
                    `;

                    CERTIFICATION_FORM_STRUCTURE.forEach(section => {
                        certificationHTML += `<div style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                        certificationHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px;">${section.title}</h3>`;
                        certificationHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;
                        
                        section.fields.forEach(field => {
                            const value = data[field.id] || 'N/A';
                            let valueCellStyle = "padding: 8px 6px; vertical-align: top; border: 1px solid #B0C4DE; font-size: 11px;";
                            let labelCellStyle = "padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE; font-size: 11px;";

                            if (field.type === 'textarea') {
                                valueCellStyle += " word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 40px;";
                            }

                            certificationHTML += `
                                <tr>
                                    <td style="${labelCellStyle}">${field.label}:</td>
                                    <td style="${valueCellStyle} width: 65%;">${value}</td>
                                </tr>
                            `;
                        });
                        
                        certificationHTML += '</table></div>';
                    });

                    // Firmas en el PDF
                    certificationHTML += `
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px dashed #B0C4DE; width: 100%;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; width: 100%;">
                                <div style="width: 45%; text-align: center;">
                                    Firma Gerente T√©cnico:
                                    <div style="border-top: 1px solid #36454F; margin-top: 60px; padding-top: 10px;"></div>
                                </div>
                                <div style="width: 45%; text-align: center;">
                                    Firma Jefe T√©cnico:
                                    <div style="border-top: 1px solid #36454F; margin-top: 60px; padding-top: 10px;"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    certificationHTML += '</div>';

                    printContainer.innerHTML = certificationHTML;
                    document.body.appendChild(printContainer);

                    const opt = {
                        margin: 10,
                        filename: fileName,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true, logging: false },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    setTimeout(() => {
                        html2pdf()
                            .set(opt)
                            .from(printContainer)
                            .save()
                            .then(() => {
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                resolve();
                            })
                            .catch(error => {
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generateCertificationPDF:', error);
                    reject(error);
                }
            });
        }

        // MODIFICADA: Incluir estado en la tabla
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table').querySelector('tbody');
            const noResultsDiv = document.getElementById('no-results');
            tbody.innerHTML = '';

            // Filtrar solo √≥rdenes en curso
            let filteredOrders = workOrders.filter(order => order.estado === "En Curso");
            
            // Aplicar filtros adicionales
            if (activeFilters.length > 0) {
                filteredOrders = filteredOrders.filter(order => {
                    return activeFilters.every(filter => {
                        const fieldValue = order[filter.field] || '';
                        const filterValue = filter.value;
                        
                        switch (filter.operator) {
                            case 'contains':
                                return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                            case 'equals':
                                return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                            case 'startsWith':
                                return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                            case 'endsWith':
                                return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                            case 'range':
                                const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                                const numValue = parseFloat(fieldValue);
                                return !isNaN(numValue) && numValue >= min && numValue <= max;
                            case 'greater':
                                const greaterValue = parseFloat(fieldValue);
                                const greaterFilter = parseFloat(filterValue);
                                return !isNaN(greaterValue) && greaterValue > greaterFilter;
                            case 'less':
                                const lessValue = parseFloat(fieldValue);
                                const lessFilter = parseFloat(filterValue);
                                return !isNaN(lessValue) && lessValue < lessFilter;
                            default:
                                return true;
                        }
                    });
                });
            }

            // Ordenar las √≥rdenes por n√∫mero de OT de forma descendente
            const sortedOrders = [...filteredOrders].sort((a, b) => {
                const otA = parseInt(a['Orden de Trabajo'], 10) || 0;
                const otB = parseInt(b['Orden de Trabajo'], 10) || 0;
                return otB - otA;
            });

            if (sortedOrders.length === 0) {
                noResultsDiv.style.display = 'block';
            } else {
                noResultsDiv.style.display = 'none';
            }

            sortedOrders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                const creationDate = order['Fecha Actual'] || 'N/A';
                row.insertCell().textContent = creationDate;
                
                // Celda de estado
                const statusCell = row.insertCell();
                const statusBadge = document.createElement('span');
                statusBadge.className = `status-badge status-${order.estado.toLowerCase().replace(' ', '-')}`;
                statusBadge.textContent = order.estado;
                statusCell.appendChild(statusBadge);
                
                const actionCell = row.insertCell();
                
                // Bot√≥n de Descarga PDF
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '‚¨áÔ∏è PDF';
                downloadBtn.style.backgroundColor = '#77DD77';
                downloadBtn.onclick = () => downloadOrder(order.id);
                actionCell.appendChild(downloadBtn);
                
                // NUEVO: Bot√≥n de Finalizar
                const finalizeBtn = document.createElement('button');
                finalizeBtn.textContent = '‚úÖ Finalizar';
                finalizeBtn.className = 'finalize-button';
                finalizeBtn.style.marginLeft = '5px';
                finalizeBtn.onclick = () => openCertificationForm(order.id);
                actionCell.appendChild(finalizeBtn);
                
                // Bot√≥n de Eliminar (Solo para Admin)
                if (currentRole === 'admin') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                    deleteBtn.style.backgroundColor = 'var(--color-error)';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.marginLeft = '5px';
                    deleteBtn.onclick = () => deleteWorkOrder(order.id, order['Orden de Trabajo']);
                    actionCell.appendChild(deleteBtn);
                }
            });
        }

        // NUEVA FUNCI√ìN: Renderizar tabla de √≥rdenes finalizadas
        function renderCompletedOrdersTable() {
            const tbody = document.getElementById('completed-orders-table').querySelector('tbody');
            const noResultsDiv = document.getElementById('completed-no-results');
            tbody.innerHTML = '';

            // Filtrar solo √≥rdenes finalizadas
            let filteredOrders = workOrders.filter(order => order.estado === "Finalizada");
            
            // Aplicar filtros
            if (completedFilters.length > 0) {
                filteredOrders = filteredOrders.filter(order => {
                    return completedFilters.every(filter => {
                        const fieldValue = order[filter.field] || '';
                        const filterValue = filter.value;
                        
                        switch (filter.operator) {
                            case 'contains':
                                return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                            case 'equals':
                                return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                            case 'startsWith':
                                return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                            case 'endsWith':
                                return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                            case 'range':
                                const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                                const numValue = parseFloat(fieldValue);
                                return !isNaN(numValue) && numValue >= min && numValue <= max;
                            case 'greater':
                                const greaterValue = parseFloat(fieldValue);
                                const greaterFilter = parseFloat(filterValue);
                                return !isNaN(greaterValue) && greaterValue > greaterFilter;
                            case 'less':
                                const lessValue = parseFloat(fieldValue);
                                const lessFilter = parseFloat(filterValue);
                                return !isNaN(lessValue) && lessValue < lessFilter;
                            default:
                                return true;
                        }
                    });
                });
            }

            // Ordenar por fecha de finalizaci√≥n descendente
            const sortedOrders = [...filteredOrders].sort((a, b) => {
                const dateA = new Date(a.fecha_finalizacion || 0);
                const dateB = new Date(b.fecha_finalizacion || 0);
                return dateB - dateA;
            });

            if (sortedOrders.length === 0) {
                noResultsDiv.style.display = 'block';
            } else {
                noResultsDiv.style.display = 'none';
            }

            sortedOrders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                const creationDate = order['Fecha Actual'] || 'N/A';
                row.insertCell().textContent = creationDate;
                
                const completionDate = order.fecha_finalizacion ? 
                    new Date(order.fecha_finalizacion).toLocaleDateString('es-ES') : 'N/A';
                row.insertCell().textContent = completionDate;
                
                const actionCell = row.insertCell();
                
                // Bot√≥n de Descarga PDF de la orden original
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '‚¨áÔ∏è PDF Orden';
                downloadBtn.style.backgroundColor = '#77DD77';
                downloadBtn.onclick = () => downloadOrder(order.id);
                actionCell.appendChild(downloadBtn);
                
                // Bot√≥n de Descarga PDF de certificaci√≥n
                const certDownloadBtn = document.createElement('button');
                certDownloadBtn.textContent = 'üìÑ PDF Certificaci√≥n';
                certDownloadBtn.className = 'view-certificate-button';
                certDownloadBtn.style.marginLeft = '5px';
                certDownloadBtn.onclick = () => downloadCertification(order.id);
                actionCell.appendChild(certDownloadBtn);
            });
        }

        // NUEVA FUNCI√ìN: Descargar certificaci√≥n
        async function downloadCertification(orderId) {
            try {
                // Buscar la certificaci√≥n en Firebase
                const certSnapshot = await CERTIFICATIONS_COLLECTION
                    .where('orderId', '==', orderId)
                    .get();
                
                if (certSnapshot.empty) {
                    alert('No se encontr√≥ la certificaci√≥n para esta orden.');
                    return;
                }
                
                const certData = certSnapshot.docs[0].data();
                await generateCertificationPDF(certData);
                
            } catch (error) {
                console.error('Error al descargar certificaci√≥n:', error);
                alert('Error al descargar la certificaci√≥n: ' + error.message);
            }
        }

        // [MANTENER EL RESTO DE LAS FUNCIONES EXISTENTES...]

        // NUEVAS FUNCIONES PARA FILTROS DE √ìRDENES FINALIZADAS
        function initializeCompletedFilters() {
            const filterFieldSelect = document.getElementById('completed-filter-field');
            filterFieldSelect.innerHTML = '<option value="">Seleccionar campo...</option>';
            
            const availableFields = new Set();
            availableFields.add('Orden de Trabajo');
            availableFields.add('T√≠tulo del Formulario');
            availableFields.add('Fecha Actual');
            
            Array.from(availableFields).sort().forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                filterFieldSelect.appendChild(option);
            });
            
            updateCompletedActiveFiltersDisplay();
        }

        function updateCompletedFilterInput() {
            // Implementaci√≥n similar a updateFilterInput pero para completed filters
            const fieldSelect = document.getElementById('completed-filter-field');
            const operatorSelect = document.getElementById('completed-filter-operator');
            const valueContainer = document.getElementById('completed-filter-value-container');
            
            const selectedField = fieldSelect.value;
            const selectedOperator = operatorSelect.value;
            
            valueContainer.innerHTML = '';
            
            if (!selectedField) {
                valueContainer.innerHTML = '<label for="completed-filter-value">Valor:</label><input type="text" id="completed-filter-value" placeholder="Seleccione un campo primero...">';
                return;
            }
            
            const label = document.createElement('label');
            label.htmlFor = 'completed-filter-value';
            label.textContent = 'Valor:';
            valueContainer.appendChild(label);
            
            if (selectedOperator === 'range') {
                const rangeDiv = document.createElement('div');
                rangeDiv.className = 'range-inputs';
                rangeDiv.innerHTML = `
                    <input type="number" id="completed-filter-value-min" placeholder="M√≠nimo">
                    <span style="align-self: center;">a</span>
                    <input type="number" id="completed-filter-value-max" placeholder="M√°ximo">
                `;
                valueContainer.appendChild(rangeDiv);
            } else {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'completed-filter-value';
                input.placeholder = 'Texto a buscar...';
                valueContainer.appendChild(input);
            }
        }

        function addCompletedFilter() {
            const fieldSelect = document.getElementById('completed-filter-field');
            const operatorSelect = document.getElementById('completed-filter-operator');
            const selectedField = fieldSelect.value;
            const selectedOperator = operatorSelect.value;
            
            if (!selectedField) {
                alert('Por favor, seleccione un campo para filtrar.');
                return;
            }
            
            let filterValue = '';
            
            if (selectedOperator === 'range') {
                const minValue = document.getElementById('completed-filter-value-min').value;
                const maxValue = document.getElementById('completed-filter-value-max').value;
                
                if (!minValue || !maxValue) {
                    alert('Por favor, complete ambos valores para el rango.');
                    return;
                }
                
                filterValue = `${minValue}-${maxValue}`;
            } else {
                const valueInput = document.getElementById('completed-filter-value');
                filterValue = valueInput.value.trim();
                
                if (!filterValue) {
                    alert('Por favor, ingrese un valor para el filtro.');
                    return;
                }
            }
            
            const existingFilter = completedFilters.find(f => 
                f.field === selectedField && f.operator === selectedOperator && f.value === filterValue
            );
            
            if (existingFilter) {
                alert('Este filtro ya est√° activo.');
                return;
            }
            
            completedFilters.push({
                field: selectedField,
                operator: selectedOperator,
                value: filterValue
            });
            
            updateCompletedActiveFiltersDisplay();
            renderCompletedOrdersTable();
            
            fieldSelect.value = '';
            operatorSelect.value = 'contains';
            updateCompletedFilterInput();
        }

        function clearCompletedFilters() {
            completedFilters = [];
            updateCompletedActiveFiltersDisplay();
            renderCompletedOrdersTable();
        }

        function updateCompletedActiveFiltersDisplay() {
            const activeFiltersDiv = document.getElementById('completed-active-filters');
            const activeFiltersList = document.getElementById('completed-active-filters-list');
            
            if (completedFilters.length === 0) {
                activeFiltersDiv.style.display = 'none';
                return;
            }
            
            activeFiltersDiv.style.display = 'block';
            activeFiltersList.innerHTML = '';
            
            completedFilters.forEach((filter, index) => {
                const filterTag = document.createElement('span');
                filterTag.className = 'active-filter-tag';
                
                let operatorText = '';
                switch (filter.operator) {
                    case 'contains': operatorText = 'contiene'; break;
                    case 'equals': operatorText = 'es igual a'; break;
                    case 'startsWith': operatorText = 'comienza con'; break;
                    case 'endsWith': operatorText = 'termina con'; break;
                    case 'range': operatorText = 'est√° entre'; break;
                    case 'greater': operatorText = 'es mayor que'; break;
                    case 'less': operatorText = 'es menor que'; break;
                }
                
                filterTag.innerHTML = `
                    <strong>${filter.field}</strong> ${operatorText} "${filter.value}"
                    <span class="remove-filter" onclick="removeCompletedFilter(${index})">√ó</span>
                `;
                
                activeFiltersList.appendChild(filterTag);
            });
        }

        function removeCompletedFilter(index) {
            completedFilters.splice(index, 1);
            updateCompletedActiveFiltersDisplay();
            renderCompletedOrdersTable();
        }

    </script>

</body>
</html>
