<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition (Seguro)</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* [MANTENER TODOS LOS ESTILOS EXISTENTES] */
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;         /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;    /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE;  /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;     /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;       /* Gris carb√≥n (Charcoal) */
            --color-white: #ffffff;
            --color-error: #FF6961;      /* Rojo pastel para errores */
            --color-success: #77DD77;    /* Verde pastel para √©xito */
            --color-warning: #FFB347;    /* Naranja pastel para advertencias */
            --color-filter: #DDA0DD;     /* Color para elementos de filtro */
        }

        /* [MANTENER TODOS LOS ESTILOS EXISTENTES...] */
        /* ... (todos los estilos CSS anteriores se mantienen igual) ... */
        
    </style>
</head>
<body>

    <!-- [MANTENER TODA LA ESTRUCTURA HTML EXISTENTE] -->
    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <!-- [MANTENER TODAS LAS PESTA√ëAS Y ESTRUCTURA EXISTENTE...] -->
        
    </div>

    <script>
        // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
        
        // ** CONFIGURACI√ìN DE FIREBASE ACTUALIZADA **
        const firebaseConfig = {
          apiKey: "AIzaSyC40g7AnTbn2mtamOx_siPhckajgNCjZmg",
          authDomain: "gestionordenestrabajo.firebaseapp.com",
          projectId: "gestionordenestrabajo",
          storageBucket: "gestionordenestrabajo.firebasestorage.app",
          messagingSenderId: "478774861151",
          appId: "1:478774861151:web:e956dca23988e5d8fceaea"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Referencias a las "colecciones" de la base de datos
        const ORDERS_COLLECTION = db.collection("workOrders");
        const CONFIG_COLLECTION = db.collection("config"); 
        const CERTIFICATIONS_COLLECTION = db.collection("certifications");
        
        // Variables de estado
        let formStructure = null; 
        let workOrders = []; 
        let otCounter = 1; 
        let currentRole = null; 
        let activeFilters = [];
        let completedFilters = [];
        let currentOrderForCertification = null;

        // ----------------------------------------------------------------------------------
        // *** CONFIGURACI√ìN DE ROLES CON M√öLTIPLES CORREOS (LISTAS/ARRAYS) ***
        // ----------------------------------------------------------------------------------

        // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de administrador
        const ADMIN_EMAILS = [
            'labortradingsg@gmail.com',
            ''
        ]; 

        // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de solo visualizaci√≥n
        const VIEWER_EMAILS = [
            'visualizador1@empresa.com',
            'visualizador2@empresa.com',
            'solo.ver@tudominio.com'
        ]; 

        // ----------------------------------------------------------------------------------
        // *** FIN CONFIGURACI√ìN DE ROLES ***
        // ----------------------------------------------------------------------------------
        
        // *** DATOS FIJOS PARA AUTOLENADO DE CONTRATISTAS ***
        const CONTRATISTAS_DATA = {
            // [MANTENER TODOS LOS DATOS DE CONTRATISTAS EXISTENTES...]
        };

        // Estructura del formulario de certificaci√≥n
        const CERTIFICATION_FORM_STRUCTURE = [
            { 
                title: "I. Datos de Certificaci√≥n", 
                fields: [
                    { id: "certification_number", label: "N√∫mero de Certificaci√≥n", type: "static", value: "", required: true },
                    { id: "certification_date", label: "Fecha", type: "date-auto", required: true }
                ]
            },
            { 
                title: "II. Identificaci√≥n", 
                fields: [
                    { id: "certification_empresa", label: "Empresa", type: "static", value: "", required: true },
                    { id: "certification_responsable", label: "Apellido y Nombre del Responsable", type: "static", value: "", required: true },
                    { id: "certification_rif", label: "Rif", type: "static", value: "", required: true }
                ]
            },
            { 
                title: "III. Informaci√≥n del Proyecto", 
                fields: [
                    { id: "certification_reference", label: "Referencia Orden de Trabajo", type: "static", value: "", required: true },
                    { id: "start_date", label: "Fecha de Inicio", type: "date-input", required: true },
                    { id: "end_date", label: "Fecha de finalizaci√≥n", type: "date-input", required: true }
                ]
            },
            { 
                title: "IV. Detalle de los trabajos", 
                fields: [
                    { id: "conceptos_ejecutados", label: "Conceptos Ejecutados en el per√≠odo de tiempo", type: "textarea", required: true },
                    { id: "total_acreditado", label: "Total Acreditado en Certificaci√≥n", type: "text", required: true },
                    { id: "porcentaje_presupuesto", label: "Porcentaje sobre el presupuesto total", type: "text", required: true },
                    { id: "importe_final", label: "Importe final acreditado en la construcci√≥n", type: "text", required: true }
                ]
            },
            { 
                title: "V. Desviaciones y Justificaci√≥n", 
                fields: [
                    { id: "desviaciones_justificacion", label: "Desviaciones y Justificaci√≥n", type: "textarea", required: true }
                ]
            }
        ];

        // Estructura inicial por defecto 
        const DEFAULT_FORM_STRUCTURE = [
            { title: "I. Informaci√≥n General", fields: [
                { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                { id: "ot_number", label: "Orden de Trabajo", type: "ot_counter", required: true },
                { id: "user_auto_fill", label: "Usuario que Crea la Orden", type: "user-auto-fill", required: true },
                { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true }
            ]},
            { title: "II. Informaci√≥n de la Contratista", fields: []},
            { title: "III. Informaci√≥n del Trabajo/Obra", fields: []}
        ];
        
        // *** [MANTENER TODAS LAS FUNCIONES EXISTENTES HASTA generatePDF] ***

        // *** FUNCI√ìN: Formatear texto largo para PDF - MEJORADA ***
        function formatLongTextForPDF(text, maxLineLength = 70) {
            if (!text || text === 'N/A') return 'N/A';
            
            let formattedText = text.replace(/<br\s*\/?>/gi, '\n');
            
            if (formattedText.length <= maxLineLength && !formattedText.includes('\n')) {
                return formattedText;
            }
            
            const lines = formattedText.split('\n');
            let resultLines = [];
            
            lines.forEach(line => {
                if (line.length <= maxLineLength) {
                    resultLines.push(line);
                } else {
                    const words = line.split(' ');
                    let currentLine = '';
                    
                    words.forEach(word => {
                        if ((currentLine + ' ' + word).length <= maxLineLength) {
                            currentLine += (currentLine ? ' ' : '') + word;
                        } else {
                            if (currentLine) resultLines.push(currentLine);
                            currentLine = word;
                        }
                    });
                    
                    if (currentLine) resultLines.push(currentLine);
                }
            });
            
            return resultLines.join('\n');
        }

        // *** FUNCI√ìN generatePDF ORIGINAL (QUE FUNCIONA BIEN) ***
        function generatePDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    const otNumber = data['Orden de Trabajo'];
                    const creationDate = data['Fecha Actual'] || 'N/A';
                    const fileName = `Orden_Trabajo_${otNumber}_${creationDate.replace(/\//g, '-')}.pdf`;
                    
                    console.log('Iniciando generaci√≥n de PDF para orden:', otNumber);

                    // Crear un contenedor invisible pero en el DOM
                    const printContainer = document.createElement('div');
                    printContainer.id = 'pdf-print-container';
                    printContainer.style.cssText = `
                        position: absolute;
                        left: -9999px;
                        top: 0;
                        width: 190mm;
                        min-height: 277mm;
                        background: white;
                        padding: 10mm;
                        font-family: Arial, sans-serif;
                        box-sizing: border-box;
                        line-height: 1.4;
                        font-size: 12px;
                    `;

                    // Construir el contenido HTML completo con mejor manejo de p√°ginas
                    let formContentHTML = `
                        <div style="font-family: 'Arial', sans-serif; color: #36454F; line-height: 1.4; width: 100%;">
                            <!-- Encabezado principal (solo en primera p√°gina) -->
                            <div class="pdf-main-header">
                                <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px;">
                                    ${data['T√≠tulo del Formulario']} Nro. ${otNumber}
                                </h1>
                                
                                <div style="text-align: right; margin-bottom: 25px; font-weight: bold; color: #555; font-size: 12px;">
                                    Fecha de Emisi√≥n: ${data['Fecha Actual']}
                                </div>
                            </div>
                            
                            <!-- Encabezado para p√°ginas secundarias (se mostrar√° con CSS) -->
                            <div class="pdf-secondary-header" style="display: none;">
                                <div style="text-align: right; font-weight: bold; color: #555; font-size: 11px; margin-bottom: 15px;">
                                    ${data['T√≠tulo del Formulario']} Nro. ${otNumber} - Fecha: ${data['Fecha Actual']} - P√°gina <span class="page-number"></span>
                                </div>
                            </div>
                    `;

                    // Contenido del Formulario por Secciones (Din√°micas)
                    formStructure.forEach((section, secIndex) => {
                        
                        formContentHTML += `<div class="pdf-section" style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                        formContentHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px; page-break-after: avoid;">${section.title}</h3>`;
                        formContentHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;
                        
                        section.fields.forEach(field => {
                            const label = field.label;
                            let value = data[label] || 'N/A';
                            
                            // OMITIR CAMPOS DEL ENCABEZADO
                            if (label === 'T√≠tulo del Formulario' || label === 'Orden de Trabajo' || label === 'Fecha Actual') return;
                            
                            // APLICAR FORMATO DE FECHA
                            const fieldDefinition = section.fields.find(f => f.label === label);
                            if (fieldDefinition && fieldDefinition.type === 'date-input' && value !== 'N/A') {
                                value = formatDateToDDMMYYYY(value);
                            }
                            
                            // DETECTAR CAMPOS DE TEXTO LARGO
                            const isLongText = field.type === 'textarea' || 
                                              /descripci√≥n|descripcion|detallada|detallado|observaci√≥n|observacion|comentario|notas|detalle/i.test(label);
                            
                            let valueCellStyle = "padding: 8px 6px; vertical-align: top; border: 1px solid #B0C4DE; font-size: 11px;";
                            let labelCellStyle = "padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE; font-size: 11px;";
                            
                            if (isLongText) {
                                valueCellStyle += " word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 40px; page-break-inside: avoid;";
                                value = formatLongTextForPDF(value, 70);
                            } else {
                                valueCellStyle += " page-break-inside: avoid;";
                            }

                            formContentHTML += `
                                <tr style="page-break-inside: avoid;">
                                    <td style="${labelCellStyle}">${label}:</td>
                                    <td style="${valueCellStyle} width: 65%;">${value}</td>
                                </tr>
                            `;
                        });
                        
                        formContentHTML += '</table></div>';
                    });
                    
                    // Contenido de las Secciones Condicionales (Fijas)
                    const type = data['Tipo de Construcci√≥n Seleccionada'];
                    if (type && type !== 'Ninguno') {
                        const prefix = type.includes('Nodo') ? 'node_acceso' : 'isp';
                        
                        const pagoVgtCANTV = data[`${prefix} | Pago x VGT CANTV a cargo de Inter`] || '0.00';
                        const pagoVgtEDC = data[`${prefix} | Pago x VGT EDC a cargo de Inter`] || '0.00'; 
                        
                        const descripcionFormateada = formatLongTextForPDF(data[`${prefix} | Descripci√≥n`], 70);

                        formContentHTML += `<div class="pdf-section" style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                        formContentHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px; page-break-after: avoid;">${type}</h3>`;
                        formContentHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;

                        formContentHTML += `
                            <tr style="page-break-inside: avoid;">
                                <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE;">Costo Proyectado de la Obra:</td>
                                <td style="padding: 8px 6px; width: 65%; border: 1px solid #B0C4DE;">${data[`${prefix} | Costo Proyectado de la Obra`]}</td>
                            </tr>
                            <tr style="page-break-inside: avoid;">
                                <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Pago realizado por:</td>
                                <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data[`${prefix} | Pago realizado por`]}</td>
                            </tr>
                            
                            <tr style="background-color: #e0f7fa; page-break-inside: avoid;">
                                <td style="padding: 10px 6px; font-weight: bold; border: 1px solid #B0C4DE;">Pago x VGT CANTV a cargo de Inter:</td>
                                <td style="padding: 10px 6px; font-weight: bold; background-color: #ADD8E6; border: 1px solid #B0C4DE;">${pagoVgtCANTV}</td>
                            </tr>
                            
                            <tr style="background-color: #e0f7fa; page-break-inside: avoid;">
                                <td style="padding: 10px 6px; font-weight: bold; border: 1px solid #B0C4DE;">Pago x VGT EDC a cargo de Inter:</td>
                                <td style="padding: 10px 6px; font-weight: bold; background-color: #ADD8E6; border: 1px solid #B0C4DE;">${pagoVgtEDC}</td>
                            </tr>
                            
                            <tr style="page-break-inside: avoid;">
                                <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Descripci√≥n:</td>
                                <td style="padding: 8px 6px; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 60px; border: 1px solid #B0C4DE; page-break-inside: avoid;">${descripcionFormateada}</td>
                            </tr>
                            
                            <tr style="page-break-inside: avoid;">
                                <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Abono Mensual a Recibir por el cliente:</td>
                                <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data[`${prefix} | Abono Mensual a Recibir por el cliente`]}</td>
                            </tr>
                        `;

                        formContentHTML += '</table></div>';
                    }

                    // SECCI√ìN DE FIRMAS con manejo de p√°gina
                    formContentHTML += `
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px dashed #B0C4DE; width: 100%; page-break-inside: avoid;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; width: 100%;">
                                <div style="width: 45%;">
                                    Firma Contratista:
                                    <div style="border-top: 1px solid #36454F; margin-top: 5px; padding-top: 40px;"></div>
                                </div>
                                <div style="width: 45%;">
                                    Firma Responsable:
                                    <div style="border-top: 1px solid #36454F; margin-top: 5px; padding-top: 40px;"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    formContentHTML += '</div>';

                    // Agregar CSS para control de p√°ginas
                    const pageBreakCSS = `
                        <style>
                            @media print {
                                @page {
                                    margin: 10mm;
                                    size: A4;
                                }
                                
                                .pdf-main-header {
                                    display: block;
                                }
                                
                                .pdf-secondary-header {
                                    display: block !important;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 1px solid #B0C4DE;
                                }
                                
                                .pdf-section {
                                    page-break-inside: avoid;
                                    break-inside: avoid;
                                }
                                
                                table {
                                    page-break-inside: auto;
                                }
                                
                                tr {
                                    page-break-inside: avoid;
                                    page-break-after: auto;
                                }
                                
                                .keep-together {
                                    page-break-inside: avoid;
                                }
                                
                                .page-break {
                                    page-break-before: always;
                                }
                                
                                .signature-section {
                                    page-break-before: avoid;
                                    page-break-inside: avoid;
                                }
                            }
                            
                            body {
                                margin: 0;
                                padding: 0;
                                font-family: Arial, sans-serif;
                                line-height: 1.4;
                            }
                        </style>
                    `;

                    // Asignar el contenido al contenedor
                    printContainer.innerHTML = pageBreakCSS + formContentHTML;
                    
                    // Agregar al DOM para que se renderice
                    document.body.appendChild(printContainer);

                    console.log('Contenedor PDF creado y agregado al DOM');

                    const opt = {
                        margin:       10,
                        filename:     fileName,
                        image:        { 
                            type: 'jpeg', 
                            quality: 0.98 
                        },
                        html2canvas:  { 
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            scrollX: 0,
                            scrollY: 0,
                            onclone: function(clonedDoc) {
                                const clonedContainer = clonedDoc.getElementById('pdf-print-container');
                                if (clonedContainer) {
                                    clonedContainer.style.position = 'relative';
                                    clonedContainer.style.left = '0';
                                    clonedContainer.style.top = '0';
                                    
                                    const pageNumbers = clonedDoc.querySelectorAll('.page-number');
                                    pageNumbers.forEach((span, index) => {
                                        span.textContent = (index + 2);
                                    });
                                }
                            }
                        },
                        jsPDF:        { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true,
                            hotfixes: ["px_scaling"]
                        }
                    };

                    // Usar setTimeout para asegurar que el DOM se haya actualizado completamente
                    setTimeout(() => {
                        console.log('Generando PDF desde elemento...');
                        
                        const tempContainer = document.getElementById('pdf-print-container');
                        if (tempContainer) {
                            tempContainer.style.position = 'relative';
                            tempContainer.style.left = '0';
                            tempContainer.style.top = '0';
                        }
                        
                        html2pdf()
                            .set(opt)
                            .from(printContainer)
                            .save()
                            .then(() => {
                                console.log('PDF generado y descargado exitosamente:', fileName);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error al generar PDF:', error);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generatePDF:', error);
                    const printContainer = document.getElementById('pdf-print-container');
                    if (printContainer && document.body.contains(printContainer)) {
                        document.body.removeChild(printContainer);
                    }
                    reject(error);
                }
            });
        }

        // *** NUEVA FUNCI√ìN: generateCertificationPDF - USANDO EL MISMO M√âTODO QUE generatePDF ***
        function generateCertificationPDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    const fileName = `Certificacion_Obra_${data.orderNumber}_${getCurrentCaracasDate().replace(/\//g, '-')}.pdf`;
                    
                    console.log('Iniciando generaci√≥n de PDF de certificaci√≥n para orden:', data.orderNumber);

                    // Crear un contenedor invisible pero en el DOM - MISMOS ESTILOS QUE generatePDF
                    const printContainer = document.createElement('div');
                    printContainer.id = 'certification-pdf-print-container';
                    printContainer.style.cssText = `
                        position: absolute;
                        left: -9999px;
                        top: 0;
                        width: 190mm;
                        min-height: 277mm;
                        background: white;
                        padding: 10mm;
                        font-family: Arial, sans-serif;
                        box-sizing: border-box;
                        line-height: 1.4;
                        font-size: 12px;
                    `;

                    // Construir el contenido HTML usando el MISMO formato que generatePDF
                    let certificationHTML = `
                        <div style="font-family: 'Arial', sans-serif; color: #36454F; line-height: 1.4; width: 100%;">
                            <!-- Encabezado principal -->
                            <div class="pdf-main-header">
                                <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px;">
                                    Certificaci√≥n de Obra - Nro. ${data.certification_number || data.orderNumber}
                                </h1>
                                
                                <div style="text-align: right; margin-bottom: 25px; font-weight: bold; color: #555; font-size: 12px;">
                                    Fecha de Emisi√≥n: ${data.certification_date || getCurrentCaracasDate()}
                                </div>
                            </div>
                            
                            <!-- Encabezado para p√°ginas secundarias -->
                            <div class="pdf-secondary-header" style="display: none;">
                                <div style="text-align: right; font-weight: bold; color: #555; font-size: 11px; margin-bottom: 15px;">
                                    Certificaci√≥n de Obra - Nro. ${data.certification_number || data.orderNumber} - Fecha: ${data.certification_date || getCurrentCaracasDate()} - P√°gina <span class="page-number"></span>
                                </div>
                            </div>
                    `;

                    // Contenido del Formulario de Certificaci√≥n por Secciones
                    CERTIFICATION_FORM_STRUCTURE.forEach((section, secIndex) => {
                        
                        certificationHTML += `<div class="pdf-section" style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                        certificationHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px; page-break-after: avoid;">${section.title}</h3>`;
                        certificationHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;
                        
                        section.fields.forEach(field => {
                            const label = field.label;
                            let value = data[field.id] || 'N/A';
                            
                            // Formatear fechas
                            if (field.type === 'date-input' && value !== 'N/A') {
                                value = formatDateToDDMMYYYY(value);
                            }
                            
                            // DETECTAR CAMPOS DE TEXTO LARGO
                            const isLongText = field.type === 'textarea';
                            
                            let valueCellStyle = "padding: 8px 6px; vertical-align: top; border: 1px solid #B0C4DE; font-size: 11px;";
                            let labelCellStyle = "padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE; font-size: 11px;";
                            
                            if (isLongText) {
                                valueCellStyle += " word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 40px; page-break-inside: avoid;";
                                value = formatLongTextForPDF(value, 70);
                            } else {
                                valueCellStyle += " page-break-inside: avoid;";
                            }

                            certificationHTML += `
                                <tr style="page-break-inside: avoid;">
                                    <td style="${labelCellStyle}">${label}:</td>
                                    <td style="${valueCellStyle} width: 65%;">${value}</td>
                                </tr>
                            `;
                        });
                        
                        certificationHTML += '</table></div>';
                    });

                    // FIRMAS - Mismo formato que generatePDF
                    certificationHTML += `
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px dashed #B0C4DE; width: 100%; page-break-inside: avoid;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; width: 100%;">
                                <div style="width: 45%; text-align: center;">
                                    Firma Gerente T√©cnico:
                                    <div style="border-top: 1px solid #36454F; margin-top: 60px; padding-top: 10px;"></div>
                                </div>
                                <div style="width: 45%; text-align: center;">
                                    Firma Jefe T√©cnico:
                                    <div style="border-top: 1px solid #36454F; margin-top: 60px; padding-top: 10px;"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    certificationHTML += '</div>';

                    // Agregar CSS para control de p√°ginas - MISMO CSS que generatePDF
                    const pageBreakCSS = `
                        <style>
                            @media print {
                                @page {
                                    margin: 10mm;
                                    size: A4;
                                }
                                
                                .pdf-main-header {
                                    display: block;
                                }
                                
                                .pdf-secondary-header {
                                    display: block !important;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 1px solid #B0C4DE;
                                }
                                
                                .pdf-section {
                                    page-break-inside: avoid;
                                    break-inside: avoid;
                                }
                                
                                table {
                                    page-break-inside: auto;
                                }
                                
                                tr {
                                    page-break-inside: avoid;
                                    page-break-after: auto;
                                }
                                
                                .keep-together {
                                    page-break-inside: avoid;
                                }
                                
                                .page-break {
                                    page-break-before: always;
                                }
                                
                                .signature-section {
                                    page-break-before: avoid;
                                    page-break-inside: avoid;
                                }
                            }
                            
                            body {
                                margin: 0;
                                padding: 0;
                                font-family: Arial, sans-serif;
                                line-height: 1.4;
                            }
                        </style>
                    `;

                    // Asignar el contenido al contenedor
                    printContainer.innerHTML = pageBreakCSS + certificationHTML;
                    
                    // Agregar al DOM para que se renderice
                    document.body.appendChild(printContainer);

                    console.log('Contenedor PDF de certificaci√≥n creado y agregado al DOM');

                    // MISMAS OPCIONES que generatePDF
                    const opt = {
                        margin:       10,
                        filename:     fileName,
                        image:        { 
                            type: 'jpeg', 
                            quality: 0.98 
                        },
                        html2canvas:  { 
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            scrollX: 0,
                            scrollY: 0,
                            onclone: function(clonedDoc) {
                                const clonedContainer = clonedDoc.getElementById('certification-pdf-print-container');
                                if (clonedContainer) {
                                    clonedContainer.style.position = 'relative';
                                    clonedContainer.style.left = '0';
                                    clonedContainer.style.top = '0';
                                    
                                    const pageNumbers = clonedDoc.querySelectorAll('.page-number');
                                    pageNumbers.forEach((span, index) => {
                                        span.textContent = (index + 2);
                                    });
                                }
                            }
                        },
                        jsPDF:        { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true,
                            hotfixes: ["px_scaling"]
                        }
                    };

                    // MISMO setTimeout que generatePDF
                    setTimeout(() => {
                        console.log('Generando PDF de certificaci√≥n desde elemento...');
                        
                        const tempContainer = document.getElementById('certification-pdf-print-container');
                        if (tempContainer) {
                            tempContainer.style.position = 'relative';
                            tempContainer.style.left = '0';
                            tempContainer.style.top = '0';
                        }
                        
                        html2pdf()
                            .set(opt)
                            .from(printContainer)
                            .save()
                            .then(() => {
                                console.log('PDF de certificaci√≥n generado y descargado exitosamente:', fileName);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error al generar PDF de certificaci√≥n:', error);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generateCertificationPDF:', error);
                    const printContainer = document.getElementById('certification-pdf-print-container');
                    if (printContainer && document.body.contains(printContainer)) {
                        document.body.removeChild(printContainer);
                    }
                    reject(error);
                }
            });
        }

        // *** FUNCI√ìN generateCertification CORREGIDA ***
        async function generateCertification() {
            const form = document.getElementById('certification-work-form');
            
            // Validar campos requeridos
            let firstInvalidField = null;
            CERTIFICATION_FORM_STRUCTURE.forEach(section => {
                section.fields.forEach(field => {
                    if (field.required && field.type !== 'static' && field.type !== 'date-auto') {
                        const inputElement = document.getElementById(field.id);
                        if (inputElement && !inputElement.value.trim()) {
                            if (!firstInvalidField) firstInvalidField = inputElement;
                        }
                    }
                });
            });

            if (firstInvalidField) {
                alert('‚ö†Ô∏è Atenci√≥n: Debe completar todos los campos obligatorios marcados con (*).');
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
                return;
            }

            // Recopilar datos del formulario
            const certificationData = {
                orderId: currentOrderForCertification.id,
                orderNumber: currentOrderForCertification['Orden de Trabajo'],
                fecha_creacion: new Date().toISOString(),
                certificacion_completa: true
            };

            // Recopilar todos los campos del formulario
            CERTIFICATION_FORM_STRUCTURE.forEach(section => {
                section.fields.forEach(field => {
                    const inputElement = document.getElementById(field.id);
                    if (inputElement) {
                        if (field.type === 'static' || field.type === 'date-auto') {
                            certificationData[field.id] = inputElement.value;
                        } else {
                            let value = inputElement.value;
                            // Formatear fechas correctamente
                            if (field.type === 'date-input' && value) {
                                certificationData[field.id] = formatDateToDDMMYYYY(value);
                            } else {
                                certificationData[field.id] = value;
                            }
                        }
                    }
                });
            });

            console.log('Datos de certificaci√≥n a guardar:', certificationData);

            try {
                // Guardar certificaci√≥n en Firebase
                await CERTIFICATIONS_COLLECTION.add(certificationData);
                
                // Actualizar estado de la orden a "Finalizada"
                await ORDERS_COLLECTION.doc(currentOrderForCertification.id).update({
                    estado: "Finalizada",
                    fecha_finalizacion: new Date().toISOString()
                });

                // Actualizar datos locales
                const orderIndex = workOrders.findIndex(o => o.id === currentOrderForCertification.id);
                if (orderIndex !== -1) {
                    workOrders[orderIndex].estado = "Finalizada";
                    workOrders[orderIndex].fecha_finalizacion = new Date().toISOString();
                }

                // Generar PDF de certificaci√≥n usando el M√âTODO CORREGIDO
                await generateCertificationPDF(certificationData);

                alert('‚úÖ Certificaci√≥n generada exitosamente y orden marcada como finalizada.');
                
                // Volver a la vista de √≥rdenes
                goBackToOrders();
                
            } catch (error) {
                console.error('Error al generar certificaci√≥n:', error);
                alert('Error al generar la certificaci√≥n: ' + error.message);
            }
        }

        // *** [MANTENER TODAS LAS DEM√ÅS FUNCIONES EXISTENTES] ***

    </script>

</body>
</html>
