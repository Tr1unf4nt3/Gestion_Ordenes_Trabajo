<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition (Seguro)</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* [MANTENER TODOS LOS ESTILOS ANTERIORES] */
        :root {
            --color-bg: #F0F8FF;
            --color-primary: #ADD8E6;
            --color-secondary: #B0C4DE;
            --color-accent: #87CEFA;
            --color-text: #36454F;
            --color-white: #ffffff;
            --color-error: #FF6961;
            --color-success: #77DD77;
            --color-warning: #FFB347;
            --color-filter: #DDA0DD;
            --color-in-progress: #FFD700;
            --color-completed: #77DD77;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2, h3, h4 {
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 25px;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="email"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-white);
        }

        .form-section {
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #f7fbff;
        }

        button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 10px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform: 0.1s;
        }

        button:hover {
            background-color: var(--color-primary);
        }

        .tab { overflow: hidden; border-bottom: 1px solid var(--color-secondary); margin-bottom: 20px; }
        .tablinks { background-color: var(--color-bg); color: var(--color-text); float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: 0.3s; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .tablinks:hover { background-color: var(--color-primary); }
        .tablinks.active { background-color: var(--color-primary); border-bottom: 3px solid var(--color-accent); margin-bottom: -1px; }
        .tabcontent { display: none; padding: 30px 0; }

        #orders-table { width: 100%; border-collapse: collapse; }
        #orders-table th, #orders-table td { border: 1px solid var(--color-secondary); padding: 12px; text-align: left; }
        #orders-table th { background-color: var(--color-primary); color: var(--color-text); }

        #login-view { width: 350px; padding: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--color-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-error { color: var(--color-error); font-weight: bold; }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85em;
            text-align: center;
        }
        
        .status-in-progress {
            background-color: var(--color-in-progress);
            color: #333;
        }
        
        .status-completed {
            background-color: var(--color-completed);
            color: white;
        }
        
        .complete-button {
            background-color: var(--color-success);
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .modal-back-button {
            background-color: var(--color-secondary);
            color: white;
        }
        
        .modal-accept-button {
            background-color: var(--color-success);
            color: white;
        }

    </style>
</head>
<body>

    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tab">
            <button class="tablinks" id="new-order-tab-button" onclick="openTab(event, 'new-order')">üìã Nueva Orden de Trabajo</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes en Curso</button>
            <button class="tablinks" onclick="openTab(event, 'completed-orders')">‚úÖ √ìrdenes Finalizadas</button>
            <button class="tablinks" id="edit-tab-button" onclick="openTab(event, 'edit-form')" style="display: none;">‚öôÔ∏è Edici√≥n de Formulario</button>
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Contenido de las Pesta√±as -->
        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <div id="view-orders" class="tabcontent">
            <h3>√ìrdenes de Trabajo en Curso</h3>
            <table id="orders-table">
                <thead>
                    <tr>
                        <th>Nro. OT</th>
                        <th>T√≠tulo</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="completed-orders" class="tabcontent">
            <h3>√ìrdenes de Trabajo Finalizadas</h3>
            <table id="completed-orders-table">
                <thead>
                    <tr>
                        <th>Nro. OT</th>
                        <th>T√≠tulo</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Fecha Finalizaci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="edit-form" class="tabcontent">
            <h3>Edici√≥n de Formulario</h3>
            <div id="form-editor"></div>
            <button onclick="saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>
        </div>
    </div>

    <!-- Modal para Certificaci√≥n de Obras -->
    <div id="certification-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="certification-title">Certificaci√≥n de Obras</h3>
            <form id="certification-form">
                <div class="form-section">
                    <h4>I. Datos de Certificaci√≥n</h4>
                    <p>
                        <label for="certification-number">N√∫mero de Certificaci√≥n:</label>
                        <input type="text" id="certification-number" disabled>
                    </p>
                    <p>
                        <label for="certification-date">Fecha de la Certificaci√≥n:</label>
                        <input type="text" id="certification-date" disabled>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>II. Identificaci√≥n</h4>
                    <p>
                        <label for="contractor-company">Empresa Contratista:</label>
                        <input type="text" id="contractor-company" disabled>
                    </p>
                    <p>
                        <label for="contractor-rif">Identificaci√≥n Fiscal RIF:</label>
                        <input type="text" id="contractor-rif" disabled>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>III. Informaci√≥n del Proyecto</h4>
                    <p>
                        <label for="work-order-reference">Corresponde Orden de trabajo N¬∞:</label>
                        <input type="text" id="work-order-reference" disabled>
                    </p>
                    <p>
                        <label for="start-date">Fechas de Inicio:</label>
                        <input type="date" id="start-date" required>
                    </p>
                    <p>
                        <label for="end-date">Fin de la Obra:</label>
                        <input type="date" id="end-date" required>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>IV. Detalle de los trabajos realizados</h4>
                    <p>
                        <textarea id="work-details" required style="min-height: 120px;" placeholder="Describa detalladamente los trabajos realizados..."></textarea>
                    </p>
                    <p>
                        <label for="total-amount">Importe total de la obra:</label>
                        <input type="number" id="total-amount" step="0.01" min="0" required placeholder="0.00">
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>V. Desviaciones y Justificaci√≥n</h4>
                    <p>
                        <textarea id="deviations" style="min-height: 100px;" placeholder="Detalle de desviaciones respecto al plan original (Justificar y valorar en caso de existir)..."></textarea>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>Firmas</h4>
                    <div style="display: flex; justify-content: space-between;">
                        <div style="width: 45%;">
                            <p><strong>Firma Jefe T√©cnico (Firma/Sello)</strong></p>
                            <div style="border-bottom: 1px solid #36454F; margin-top: 40px;"></div>
                        </div>
                        <div style="width: 45%;">
                            <p><strong>Firma Gerente T√©cnico (Firma/Sello)</strong></p>
                            <div style="border-bottom: 1px solid #36454F; margin-top: 40px;"></div>
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="modal-actions">
                <button class="modal-back-button" onclick="closeCertificationModal()">‚Üê Atr√°s</button>
                <button class="modal-accept-button" onclick="completeWorkOrder()">‚úÖ Aceptar y Finalizar Orden</button>
            </div>
        </div>
    </div>

    <script>
        // *** CONFIGURACI√ìN FIREBASE ***
        const firebaseConfig = {
          apiKey: "AIzaSyC40g7AnTbn2mtamOx_siPhckajgNCjZmg",
          authDomain: "gestionordenestrabajo.firebaseapp.com",
          projectId: "gestionordenestrabajo",
          storageBucket: "gestionordenestrabajo.firebasestorage.app",
          messagingSenderId: "478774861151",
          appId: "1:478774861151:web:e956dca23988e5d8fceaea"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const ORDERS_COLLECTION = db.collection("workOrders");
        const COMPLETED_ORDERS_COLLECTION = db.collection("completedWorkOrders");
        const CONFIG_COLLECTION = db.collection("config"); 
        
        // Variables de estado
        let formStructure = null; 
        let workOrders = []; 
        let completedOrders = [];
        let otCounter = 1; 
        let currentRole = null; 
        let currentOrderForCertification = null;

        // Configuraci√≥n de roles
        const ADMIN_EMAILS = ['labortradingsg@gmail.com'];
        const VIEWER_EMAILS = [];

        // Estructura inicial del formulario
        const DEFAULT_FORM_STRUCTURE = [
            { title: "I. Informaci√≥n General", fields: [
                { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                { id: "ot_number", label: "Orden de Trabajo", type: "ot_counter", required: true },
                { id: "user_auto_fill", label: "Usuario que Crea la Orden", type: "user-auto-fill", required: true },
                { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true }
            ]},
            { title: "II. Informaci√≥n de la Contratista", fields: []},
            { title: "III. Informaci√≥n del Trabajo/Obra", fields: []}
        ];

        // *** FUNCIONES PRINCIPALES ***

        async function loadInitialData() {
            try {
                const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                if (configDoc.exists) {
                    const data = configDoc.data();
                    formStructure = data.formStructure || DEFAULT_FORM_STRUCTURE;
                    otCounter = data.otCounter || 1;
                } else {
                    formStructure = DEFAULT_FORM_STRUCTURE;
                    await saveFormStructure(true); 
                }
                
                const ordersSnapshot = await ORDERS_COLLECTION.orderBy('Fecha Actual', 'desc').get();
                workOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const completedSnapshot = await COMPLETED_ORDERS_COLLECTION.orderBy('Fecha Actual', 'desc').get();
                completedOrders = completedSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                recalculateOtCounter();

            } catch (e) {
                console.error("Error cargando datos iniciales: ", e);
                alert("Error al conectar con la base de datos. Detalles: " + e.message);
            }
        }
        
        async function saveFormStructure(initial = false) {
            try {
                await CONFIG_COLLECTION.doc("systemConfig").set({
                    formStructure: formStructure,
                    otCounter: otCounter
                }, { merge: true });

                if (!initial) {
                     alert('üéâ Estructura del formulario y contador guardados exitosamente en la nube.');
                     renderWorkOrderForm();
                }
            } catch (e) {
                console.error("Error al guardar la estructura:", e);
                alert("Error al guardar la estructura en Firebase.");
            }
        }

        function getRoleFromEmail(email) {
            if (ADMIN_EMAILS.includes(email)) return 'admin';
            else if (VIEWER_EMAILS.includes(email)) return 'viewer'; 
            else return 'normal'; 
        }

        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            
            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                
                let role = getRoleFromEmail(user.email); 
                currentRole = role;
                
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initializeApp(role);
                
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error);
                errorElement.textContent = 'Credenciales incorrectas o usuario no encontrado.';
            }
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                alert('Sesi√≥n cerrada correctamente.');
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
            });
        }

        async function initializeApp(role) {
            const isCreator = (role === 'admin' || role === 'normal');
            document.getElementById('edit-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
            document.getElementById('new-order-tab-button').style.display = isCreator ? 'inline-block' : 'none';
            
            await loadInitialData(); 
            
            if (role === 'admin') {
                renderFormEditor();
                openTab(null, 'edit-form');
            } else if (role === 'normal') {
                openTab(null, 'new-order');
            } else if (role === 'viewer') {
                openTab(null, 'view-orders'); 
            }
            
            renderWorkOrderForm();
            renderOrdersTable();
            renderCompletedOrdersTable();
        }

        window.onload = function() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    let role = getRoleFromEmail(user.email); 
                    currentRole = role;
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    initializeApp(role);
                } else {
                    currentRole = null;
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('login-view').style.display = 'block';
                }
            });
        }
        
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) evt.currentTarget.className += " active";

            if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
            else if (tabName === 'view-orders') renderOrdersTable();
            else if (tabName === 'completed-orders') renderCompletedOrdersTable();
            else if (tabName === 'edit-form' && currentRole === 'admin' && formStructure) renderFormEditor();
        }

        // *** FUNCIONES DE FORMULARIO ***
        function renderFormEditor() {
            const editorDiv = document.getElementById('form-editor');
            editorDiv.innerHTML = '';

            formStructure.forEach((section, secIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `
                    <h4>Secci√≥n ${secIndex + 1}: <input type="text" value="${section.title}" oninput="updateSectionTitle(${secIndex}, this.value)" style="width: 70%; display: inline;"></h4>
                    <button onclick="addField(${secIndex}, 'text')">‚ûï Agregar Campo de Texto</button>
                    <button onclick="addField(${secIndex}, 'textarea')">üìù Agregar √Årea de Texto</button>
                    <hr>
                    <div id="fields-container-${secIndex}"></div>
                `;
                editorDiv.appendChild(sectionDiv);

                const fieldsContainer = document.getElementById(`fields-container-${secIndex}`);
                section.fields.forEach((field, fieldIndex) => {
                    if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill') {
                        fieldsContainer.innerHTML += `<p class="required-fixed-field"><strong>${field.label}</strong> (Campo fijo obligatorio)</p>`;
                        return;
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-editor-item';
                    fieldDiv.innerHTML = `
                        <label>Etiqueta:</label>
                        <input type="text" value="${field.label}" oninput="updateFieldProperty(${secIndex}, ${fieldIndex}, 'label', this.value)">
                        <label>Tipo:</label>
                        <select onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texto (Corto)</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>√Årea de Texto (Largo)</option>
                            <option value="date-input" ${field.type === 'date-input' ? 'selected' : ''}>Fecha (Calendario) üìÖ</option>
                        </select>
                        <label>Clasificaci√≥n:</label>
                        <input type="checkbox" id="req-${secIndex}-${fieldIndex}" ${field.required ? 'checked' : ''} onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'required', this.checked)"> 
                        <label for="req-${secIndex}-${fieldIndex}" style="display: inline-block; font-weight: normal;">Obligatorio</label>
                        <button onclick="removeField(${secIndex}, ${fieldIndex})" style="background-color: var(--color-error); color: var(--color-white);">üóëÔ∏è Eliminar Campo</button>
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });
            });
        }
        
        function updateSectionTitle(secIndex, newTitle) { formStructure[secIndex].title = newTitle; }
        function updateFieldProperty(secIndex, fieldIndex, prop, value) { formStructure[secIndex].fields[fieldIndex][prop] = value; }
        function addField(secIndex, type) {
            const newField = {
                id: `dynamic_field_${Date.now()}`,
                label: `Nuevo Campo ${type === 'textarea' ? 'Texto Largo' : 'Texto'}`,
                type: type,
                required: false
            };
            formStructure[secIndex].fields.push(newField);
            renderFormEditor();
        }
        function removeField(secIndex, fieldIndex) {
            const isFixed = formStructure[secIndex].fields[fieldIndex].type === 'static' || 
                            formStructure[secIndex].fields[fieldIndex].type === 'ot_counter' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'date-auto' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'user-auto-fill';
            
            if (secIndex === 0 && isFixed) {
                alert("üö´ No se pueden eliminar los campos fijos y obligatorios de la primera secci√≥n.");
                return;
            }
            if (confirm('¬øEst√°s seguro de que quieres eliminar este campo?')) {
                formStructure[secIndex].fields.splice(fieldIndex, 1);
                renderFormEditor();
            }
        }

        function getCurrentCaracasDate() {
            const now = new Date();
            return now.toLocaleDateString('es-ES', { 
                timeZone: 'America/Caracas',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function renderWorkOrderForm() {
            const formElement = document.getElementById('work-order-form');
            formElement.innerHTML = '';
            const todayCaracas = getCurrentCaracasDate(); 
            const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'USUARIO NO LOGUEADO';

            if (!formStructure) {
                 formElement.innerHTML = '<p>Cargando estructura del formulario...</p>';
                 return;
            }
            
            formStructure.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `<h4>${section.title}</h4>`;

                section.fields.forEach(field => {
                    const requiredStar = field.required ? '<span style="color: var(--color-error); margin-left: 5px;">*</span>' : '';
                    let inputHTML = '';
                    let value = '';
                    let isDisabled = '';

                    const isFixedField = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill';
                    const requiredAttribute = field.required && !isFixedField ? 'required' : '';

                    switch (field.type) {
                        case 'static':
                            value = field.value;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'ot_counter':
                            value = otCounter;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'user-auto-fill':
                            value = currentUserEmail;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'date-auto':
                            value = todayCaracas;
                            inputHTML = `<input type="text" value="${value}" disabled>`; 
                            break;
                        case 'date-input':
                            inputHTML = `<input type="date" id="${field.id}" name="${field.id}" ${requiredAttribute} ${isDisabled}>`;
                            break;
                        case 'text':
                        case 'number':
                            inputHTML = `<input type="${field.type}" id="${field.id}" name="${field.id}" ${requiredAttribute} ${isDisabled}>`;
                            break;
                        case 'textarea':
                            inputHTML = `<textarea id="${field.id}" name="${field.id}" ${requiredAttribute} ${isDisabled} style="min-height: 100px;"></textarea>`;
                            break;
                    }

                    sectionDiv.innerHTML += `<p><label for="${field.id}">${field.label}${requiredStar}:</label>${inputHTML}</p>`;
                });
                formElement.appendChild(sectionDiv);
            });
        }

        async function generateWorkOrder() {
            const form = document.getElementById('work-order-form');
            let firstInvalidField = null;

            // Validaci√≥n de campos
            for (const section of formStructure) {
                for (const field of section.fields) {
                    const isFixed = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill';
                    if (!field.required || isFixed) continue;

                    const inputElement = document.getElementById(field.id);
                    if (inputElement && !inputElement.disabled && !inputElement.checkValidity()) {
                        firstInvalidField = inputElement;
                        break; 
                    }
                }
                if (firstInvalidField) break; 
            }

            if (firstInvalidField) {
                alert('‚ö†Ô∏è Atenci√≥n: Debe completar los campos obligatorios faltantes marcados con (*).');
                firstInvalidField.reportValidity();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
                return;
            }

            const formData = new FormData(form);
            const orderData = {};
            
            const caracasDate = getCurrentCaracasDate(); 
            const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'ERROR';

            // Recopilar datos
            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    let value;
                    if (field.type === 'ot_counter') value = otCounter.toString();
                    else if (field.type === 'user-auto-fill') value = currentUserEmail; 
                    else if (field.type === 'date-auto') value = caracasDate;
                    else if (field.type === 'static') value = field.value;
                    else {
                        const inputElement = document.getElementById(field.id);
                        value = inputElement ? inputElement.value : formData.get(field.id);
                    }
                    
                    orderData[field.label] = value || 'N/A';
                });
            });

            // Agregar estado
            orderData['Estado'] = 'En curso';
            orderData['Fecha de Creaci√≥n'] = caracasDate;

            try {
                const docRef = await ORDERS_COLLECTION.add(orderData); 
                orderData.id = docRef.id; 
                workOrders.push(orderData);
                otCounter++;
                await saveFormStructure(true);

                await generatePDF(orderData);

                form.reset();
                renderWorkOrderForm(); 
                renderOrdersTable(); 
                
                alert('‚úÖ Orden de Trabajo creada exitosamente y PDF generado.');
                
            } catch (e) {
                console.error("Error al crear la orden:", e);
                alert("Error al guardar la orden de trabajo en Firebase.");
            }
        }

        // *** GENERACI√ìN DE PDFs ***

        function formatLongTextForPDF(text, maxLineLength = 70) {
            if (!text || text === 'N/A') return 'N/A';
            let formattedText = text.replace(/<br\s*\/?>/gi, '\n');
            
            if (formattedText.length <= maxLineLength && !formattedText.includes('\n')) {
                return formattedText;
            }
            
            const lines = formattedText.split('\n');
            let resultLines = [];
            
            lines.forEach(line => {
                if (line.length <= maxLineLength) {
                    resultLines.push(line);
                } else {
                    const words = line.split(' ');
                    let currentLine = '';
                    
                    words.forEach(word => {
                        if ((currentLine + ' ' + word).length <= maxLineLength) {
                            currentLine += (currentLine ? ' ' : '') + word;
                        } else {
                            if (currentLine) resultLines.push(currentLine);
                            currentLine = word;
                        }
                    });
                    
                    if (currentLine) resultLines.push(currentLine);
                }
            });
            
            return resultLines.join('\n');
        }

        function generatePDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    const otNumber = data['Orden de Trabajo'];
                    const creationDate = data['Fecha Actual'] || 'N/A';
                    const fileName = `Orden_Trabajo_${otNumber}_${creationDate.replace(/\//g, '-')}.pdf`;
                    
                    const printContainer = document.createElement('div');
                    printContainer.id = 'pdf-print-container';
                    printContainer.style.cssText = `
                        position: absolute;
                        left: -9999px;
                        top: 0;
                        width: 190mm;
                        min-height: 277mm;
                        background: white;
                        padding: 10mm;
                        font-family: Arial, sans-serif;
                        box-sizing: border-box;
                        line-height: 1.4;
                        font-size: 12px;
                    `;

                    let formContentHTML = `
                        <div style="font-family: 'Arial', sans-serif; color: #36454F; line-height: 1.4; width: 100%;">
                            <div class="pdf-main-header">
                                <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px;">
                                    ${data['T√≠tulo del Formulario']} Nro. ${otNumber}
                                </h1>
                                <div style="text-align: right; margin-bottom: 25px; font-weight: bold; color: #555; font-size: 12px;">
                                    Fecha de Emisi√≥n: ${data['Fecha Actual']}
                                </div>
                            </div>
                    `;

                    formStructure.forEach((section, secIndex) => {
                        formContentHTML += `<div class="pdf-section" style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                        formContentHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px; page-break-after: avoid;">${section.title}</h3>`;
                        formContentHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;
                        
                        section.fields.forEach(field => {
                            const label = field.label;
                            let value = data[label] || 'N/A';
                            
                            if (label === 'T√≠tulo del Formulario' || label === 'Orden de Trabajo' || label === 'Fecha Actual') return;
                            
                            const isLongText = field.type === 'textarea';
                            let valueCellStyle = "padding: 8px 6px; vertical-align: top; border: 1px solid #B0C4DE; font-size: 11px;";
                            let labelCellStyle = "padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE; font-size: 11px;";
                            
                            if (isLongText) {
                                valueCellStyle += " word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 40px; page-break-inside: avoid;";
                                value = formatLongTextForPDF(value, 70);
                            }

                            formContentHTML += `
                                <tr style="page-break-inside: avoid;">
                                    <td style="${labelCellStyle}">${label}:</td>
                                    <td style="${valueCellStyle} width: 65%;">${value}</td>
                                </tr>
                            `;
                        });
                        formContentHTML += '</table></div>';
                    });

                    formContentHTML += `
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px dashed #B0C4DE; width: 100%; page-break-inside: avoid;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; width: 100%;">
                                <div style="width: 45%;">
                                    Firma Contratista:
                                    <div style="border-top: 1px solid #36454F; margin-top: 5px; padding-top: 40px;"></div>
                                </div>
                                <div style="width: 45%;">
                                    Firma Responsable:
                                    <div style="border-top: 1px solid #36454F; margin-top: 5px; padding-top: 40px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;

                    printContainer.innerHTML = formContentHTML;
                    document.body.appendChild(printContainer);

                    const opt = {
                        margin: 10,
                        filename: fileName,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true, logging: false },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    setTimeout(() => {
                        html2pdf()
                            .set(opt)
                            .from(printContainer)
                            .save()
                            .then(() => {
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                resolve();
                            })
                            .catch(error => {
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generatePDF:', error);
                    reject(error);
                }
            });
        }

        // *** SISTEMA DE CERTIFICACI√ìN ***

        function openCertificationModal(order) {
            currentOrderForCertification = order;
            
            document.getElementById('certification-title').textContent = 
                `Certificaci√≥n de Obras Nro. ${order['Orden de Trabajo']}`;
            document.getElementById('certification-number').value = order['Orden de Trabajo'];
            document.getElementById('certification-date').value = getCurrentCaracasDate();
            document.getElementById('work-order-reference').value = order['Orden de Trabajo'];
            
            // Buscar informaci√≥n de la empresa contratista
            let companyName = 'No especificada';
            let companyRif = 'No especificado';
            
            for (const key in order) {
                if (key.includes('Empresa') && order[key] && order[key] !== 'N/A' && order[key] !== 'Seleccione una Empresa') {
                    companyName = order[key];
                    break;
                }
            }
            
            for (const key in order) {
                if (key.includes('Rif') && order[key] && order[key] !== 'N/A') {
                    companyRif = order[key];
                    break;
                }
            }
            
            document.getElementById('contractor-company').value = companyName;
            document.getElementById('contractor-rif').value = companyRif;
            
            // Limpiar campos
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('work-details').value = '';
            document.getElementById('total-amount').value = '';
            document.getElementById('deviations').value = '';
            
            document.getElementById('certification-modal').style.display = 'flex';
        }

        function closeCertificationModal() {
            document.getElementById('certification-modal').style.display = 'none';
            currentOrderForCertification = null;
        }

        async function completeWorkOrder() {
            if (!currentOrderForCertification) {
                alert('Error: No hay orden seleccionada para finalizar.');
                return;
            }

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const workDetails = document.getElementById('work-details').value;
            const totalAmount = document.getElementById('total-amount').value;

            if (!startDate || !endDate || !workDetails || !totalAmount) {
                alert('Por favor, complete todos los campos obligatorios del formulario de certificaci√≥n.');
                return;
            }

            try {
                // CORRECCI√ìN: Crear estructura de certificaci√≥n plana
                const certificationData = {
                    // Copiar todos los datos de la orden original
                    ...currentOrderForCertification,
                    
                    // Agregar campos de estado
                    'Estado': 'Finalizada',
                    'Fecha de Finalizaci√≥n': getCurrentCaracasDate(),
                    
                    // CORRECCI√ìN: Datos de certificaci√≥n en estructura plana
                    'Certificacion - Numero': currentOrderForCertification['Orden de Trabajo'],
                    'Certificacion - Fecha': getCurrentCaracasDate(),
                    'Certificacion - Empresa Contratista': document.getElementById('contractor-company').value,
                    'Certificacion - RIF': document.getElementById('contractor-rif').value,
                    'Certificacion - Fecha Inicio': startDate,
                    'Certificacion - Fecha Fin': endDate,
                    'Certificacion - Detalle Trabajos': workDetails,
                    'Certificacion - Importe Total': totalAmount,
                    'Certificacion - Desviaciones': document.getElementById('deviations').value
                };

                console.log('Datos de certificaci√≥n a guardar:', certificationData);

                // Mover a colecci√≥n de finalizadas
                await COMPLETED_ORDERS_COLLECTION.add(certificationData);
                await ORDERS_COLLECTION.doc(currentOrderForCertification.id).delete();
                
                workOrders = workOrders.filter(order => order.id !== currentOrderForCertification.id);
                completedOrders.push(certificationData);
                
                await generateCertificationPDF(certificationData);
                
                closeCertificationModal();
                renderOrdersTable();
                renderCompletedOrdersTable();
                
                alert('‚úÖ Orden finalizada exitosamente. Se ha generado la certificaci√≥n en PDF.');
                
            } catch (error) {
                console.error('Error al finalizar la orden:', error);
                alert('Error al finalizar la orden: ' + error.message);
            }
        }

        function generateCertificationPDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    const certificationNumber = data['Certificacion - Numero'] || data['Orden de Trabajo'];
                    const fileName = `Certificacion_Obra_${certificationNumber}_${getCurrentCaracasDate().replace(/\//g, '-')}.pdf`;
                    
                    console.log('Generando PDF de certificaci√≥n con datos:', data);

                    const printContainer = document.createElement('div');
                    printContainer.id = 'certification-pdf-container';
                    printContainer.style.cssText = `
                        position: absolute;
                        left: -9999px;
                        top: 0;
                        width: 190mm;
                        min-height: 277mm;
                        background: white;
                        padding: 10mm;
                        font-family: Arial, sans-serif;
                        box-sizing: border-box;
                        line-height: 1.4;
                        font-size: 12px;
                    `;

                    // CORRECCI√ìN: Acceso directo a los campos planos
                    const certificationContent = `
                        <div style="font-family: 'Arial', sans-serif; color: #36454F; line-height: 1.4; width: 100%;">
                            <div class="pdf-main-header">
                                <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px;">
                                    Certificaci√≥n de Obras Nro. ${certificationNumber}
                                </h1>
                            </div>
                            
                            <div class="form-section" style="margin-bottom: 20px;">
                                <h3 style="color: #4682B4; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px;">I. Datos de Certificaci√≥n</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; width: 35%; border: 1px solid #B0C4DE;">N√∫mero de Certificaci√≥n:</td>
                                        <td style="padding: 8px 6px; width: 65%; border: 1px solid #B0C4DE;">${certificationNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">Fecha de la Certificaci√≥n:</td>
                                        <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data['Certificacion - Fecha'] || 'N/A'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="form-section" style="margin-bottom: 20px;">
                                <h3 style="color: #4682B4; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px;">II. Identificaci√≥n</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; width: 35%; border: 1px solid #B0C4DE;">Empresa Contratista:</td>
                                        <td style="padding: 8px 6px; width: 65%; border: 1px solid #B0C4DE;">${data['Certificacion - Empresa Contratista'] || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">Identificaci√≥n Fiscal RIF:</td>
                                        <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data['Certificacion - RIF'] || 'N/A'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="form-section" style="margin-bottom: 20px;">
                                <h3 style="color: #4682B4; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px;">III. Informaci√≥n del Proyecto</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; width: 35%; border: 1px solid #B0C4DE;">Corresponde Orden de trabajo N¬∞:</td>
                                        <td style="padding: 8px 6px; width: 65%; border: 1px solid #B0C4DE;">${certificationNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">Fechas de Inicio:</td>
                                        <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data['Certificacion - Fecha Inicio'] || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">Fin de la Obra:</td>
                                        <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data['Certificacion - Fecha Fin'] || 'N/A'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="form-section" style="margin-bottom: 20px;">
                                <h3 style="color: #4682B4; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px;">IV. Detalle de los trabajos realizados</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; width: 35%; border: 1px solid #B0C4DE;">Detalle:</td>
                                        <td style="padding: 8px 6px; width: 65%; border: 1px solid #B0C4DE; white-space: pre-wrap; min-height: 100px;">${formatLongTextForPDF(data['Certificacion - Detalle Trabajos'] || 'N/A', 70)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; border: 1px solid #B0C4DE;">Importe total de la obra:</td>
                                        <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data['Certificacion - Importe Total'] || 'N/A'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="form-section" style="margin-bottom: 20px;">
                                <h3 style="color: #4682B4; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px;">V. Desviaciones y Justificaci√≥n</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                    <tr>
                                        <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; width: 35%; border: 1px solid #B0C4DE;">Detalle de desviaciones:</td>
                                        <td style="padding: 8px 6px; width: 65%; border: 1px solid #B0C4DE; white-space: pre-wrap; min-height: 80px;">${formatLongTextForPDF(data['Certificacion - Desviaciones'] || 'No se registraron desviaciones', 70)}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="margin-top: 60px; padding-top: 30px; border-top: 2px dashed #B0C4DE;">
                                <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold;">
                                    <div style="width: 45%;">
                                        Firma Jefe T√©cnico (Firma/Sello)
                                        <div style="border-top: 1px solid #36454F; margin-top: 40px;"></div>
                                    </div>
                                    <div style="width: 45%;">
                                        Firma Gerente T√©cnico (Firma/Sello)
                                        <div style="border-top: 1px solid #36454F; margin-top: 40px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    printContainer.innerHTML = certificationContent;
                    document.body.appendChild(printContainer);

                    const opt = {
                        margin: 10,
                        filename: fileName,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true, logging: false },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    setTimeout(() => {
                        html2pdf()
                            .set(opt)
                            .from(printContainer)
                            .save()
                            .then(() => {
                                console.log('PDF de certificaci√≥n generado exitosamente');
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error al generar PDF de certificaci√≥n:', error);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generateCertificationPDF:', error);
                    reject(error);
                }
            });
        }

        // *** FUNCIONES DE TABLAS ***

        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table').querySelector('tbody');
            tbody.innerHTML = '';

            workOrders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                row.insertCell().textContent = order['Fecha Actual'] || 'N/A';
                
                const statusCell = row.insertCell();
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge status-in-progress';
                statusBadge.textContent = 'En curso';
                statusCell.appendChild(statusBadge);
                
                const actionCell = row.insertCell();
                
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '‚¨áÔ∏è PDF';
                downloadBtn.style.backgroundColor = '#77DD77'; 
                downloadBtn.style.color = 'white';
                downloadBtn.onclick = () => generatePDF(order);
                actionCell.appendChild(downloadBtn);
                
                const completeBtn = document.createElement('button');
                completeBtn.textContent = '‚úÖ Finalizar';
                completeBtn.className = 'complete-button';
                completeBtn.style.marginLeft = '5px';
                completeBtn.onclick = () => openCertificationModal(order);
                actionCell.appendChild(completeBtn);
            });
        }

        function renderCompletedOrdersTable() {
            const tbody = document.getElementById('completed-orders-table').querySelector('tbody');
            tbody.innerHTML = '';

            completedOrders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                row.insertCell().textContent = order['Fecha Actual'] || 'N/A';
                row.insertCell().textContent = order['Fecha de Finalizaci√≥n'] || 'N/A';
                
                const actionCell = row.insertCell();
                
                const orderPdfBtn = document.createElement('button');
                orderPdfBtn.textContent = 'üìã Orden';
                orderPdfBtn.style.backgroundColor = '#87CEFA';
                orderPdfBtn.style.color = 'white';
                orderPdfBtn.onclick = () => generatePDF(order);
                actionCell.appendChild(orderPdfBtn);
                
                const certPdfBtn = document.createElement('button');
                certPdfBtn.textContent = 'üìÑ Certificaci√≥n';
                certPdfBtn.style.backgroundColor = '#77DD77';
                certPdfBtn.style.color = 'white';
                certPdfBtn.style.marginLeft = '5px';
                certPdfBtn.onclick = () => generateCertificationPDF(order);
                actionCell.appendChild(certPdfBtn);
            });
        }

        function recalculateOtCounter() {
            if (workOrders.length === 0) {
                otCounter = 1;
                return;
            }
            const allOtNumbers = workOrders.map(order => {
                const otNumber = order['Orden de Trabajo'];
                return typeof otNumber === 'string' ? parseInt(otNumber, 10) : otNumber;
            }).filter(ot => !isNaN(ot));

            if (allOtNumbers.length === 0) {
                otCounter = 1;
                return;
            }
            const maxOt = Math.max(...allOtNumbers);
            otCounter = maxOt + 1;
        }

    </script>

</body>
</html>
